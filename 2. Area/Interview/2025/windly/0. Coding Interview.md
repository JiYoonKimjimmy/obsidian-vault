당신은 온라인 쇼핑몰의 백엔드 개발자입니다.
이 시스템은 고객 주문을 처리하고, 재고를 관리하며, 배송을 위한 외부 API와 연동합니다. 시스템은 다음과 같은 요구사항을 가지고 있습니다.

## 요구사항
1. **상품 주문 및 재고 관리**
	- 이 상품은 총 **100개**만 판매됩니다.
	- 한 고객당 최대 **2개까지** 구매할 수 있습니다.
	- 재고 수량은 정확하게 관리되어야 하며, **초과 판매**가 일어나면 안 됩니다.

2. **외부 배송 서비스 연동**
    - 주문이 완료되면 **외부 배송 업체의 API**를 통해 배송 요청을 해야 합니다.
    - 이 외부 API는 가끔씩 **응답이 느리거나 실패**할 수 있습니다.

3. **동시성 및 데이터 무결성**
    - 이벤트 시작과 동시에 **많은 고객**이 한꺼번에 주문할 것으로 예상됩니다.
    - 이럴 때에도 **재고 수량이 정확**해야 하고, 주문 정보가 **정상적으로 저장**되어야 합니다.

4. **시스템 성능 및 확장성**
    - 갑작스럽게 트래픽이 증가해도 시스템이 **안정적**으로 동작해야 합니다.

## 질문
1. **재고 관리 및 동시성 문제 처리**
    - 동시 주문 상황에서 **재고 수량을 정확하게 관리**하기 위해 어떤 방법을 사용할 건가요?
		- 상품 재고 수량의 동시성 제어를 위해서는 데이터 변경에 대한 트랜잭션 보장 필요합니다.
		- 트랜잭션 보장을 위해서는 자원에 대한 Lock 전략이 필요해보입니다.
		- 먼저 애플리케이션 레벨의 Lock 전략으로 API 요청에 대한 분산락을 통해 하나의 상품 변경 처리는 하나의 트랜잭션에서만 처리될 수 있도록 격리시킬 수 있을 것 같습니다.
		- 그리고 상품 주문 수량에 따라 재고 수량이 부족하지 않음을 보장하기 위해 UPDATE 쿼리 조건으로 `product_stock > order_quantity` 추가하여 잘못된 재고 수량 차감을 방지할 수 있을 것 같습니다.
    - 한 고객당 **초과 판매를 방지**하기 위한 방법을 설명해주세요.
		- 고객당 최대 2개 이하로만 상품 주문하도록 하기 위해서는 고객별 상품에 대한 주문 수량 정보 관리가 필요합니다.
		- 해당 개발 로직은 캐시를 사용한다면 보다 빠르게 검증하고 API 처리가 가능합니다.
		- Redis 와 같은 캐시 서버를 사용한다면, 회원ID 별로 해당 상품에 대한 주문 수량을 캐싱 처리하고, 상품을 주문 요청할 때 해당 캐시 정보가 2 이하인지를 검증하고, 2 이하인 경우 상품 주문 처리 후 캐싱 정보를 증가 처리하도록 할 수 있습니다.
		- 만약 Redis 로 동시에 캐싱 정보 증가 요청을 하더라도 Redis 명령어 수행은 싱글-스레드 기반으로 동작하기 때문에 해당 캐싱 정보에 대한 동시성 문제도 함께 해결할 것으로 보입니다.
    - 데이터베이스나 코드에서 적용할 **구체적인 방법**이 있으면 설명해주세요.
		- 해당 프로젝트는 Kotlin, Spring 프레임워크를 활용하여 구성하는 것으로 설명해보겠습니다.
		- 분산락 처리를 위해서는 Redis 서버를 활용할 수 있습니다.
		- 고객이 상품 주문 요청하는 경우, 해당 고객별 상품 주문 수량 캐싱 정보를 확인하고, 2 이하인 경우만 주문 서비스를 호출합니다.
		- 주문 서비스를 호출하면서 "고객ID:상품ID" 를 기반의 분산락 Key 를 생성하고, Lock 을 획득한다면, 상품 재고 차감 쿼리를 수행합니다.
		- 상품 재고 차감 쿼리는 아래와 같습니다.

2. **외부 배송 API 연동 및 에러 처리**
    - 외부 배송 업체의 API를 우리 시스템에 **어떻게 연동**할 건가요?
		- 외부 연동은 Spring 프레임워크 내부 라이브러리 RestClient 통해 연동합니다.
		- 하지만 기존 주문 서비스 트랜잭션과 분리하기 위해서, 주문 서비스 완료 & 커밋이 되는 순간 `주문 완료 이벤트` 를 발행하여 배송 API 요청 서비스를 비동기적으로 호출합니다.
		- 이벤트 발행은 메시징 브로커를 활용할 수 있지만 Spring 프레임워크의 `ApplicationEvent` 활용하는 방법으로 먼저 개발 진행하면 좋을 것 같습니다.
    - API 호출 중에 **응답이 느리거나 실패**하면 어떻게 대처할 건가요?
        - API 호출에 대한 지연이나 실패가 되는 상황을 위해 재시도 매커니즘을 적용할 수 있습니다.
        - 재시도 처리는 API 호출에 에러 발생 시 backoff 를 적절하게 지정하여 최대 3회 하도록 구성합니다.
        - 만약 3회 재시도에도 모두 실패한다면, recover 처리를 위해 해당 배송 API 요청에 대한 실패 내역을 메시징 브로커로 이벤트를 발행하도록 합니다.
        - 실패 내역에 대한 메시징 이벤트는 일시적인 delay 이후 메시지 컨슈머에서 수신하여 배송 API 서비스를 재요청합니다.
    - 이로 인해 주문 처리가 지연될 때, **사용자에게는 어떻게 안내가 되면** 좋을지 말씀해주세요.
		- 고객에게 주문 처리 지연에 대한 안내는 최초 재시도 3회 처리 시, 즉시 안내하거나 실패 내역 메시지를 수신하는 컨슈머에서 고객 안내 메시지를 발송할 수 있을 것 같습니다.
		- 주문 완료하였지만, 배송 신청 완료 후 상태 업데이트 예정이란 안내 메시지 내용으로 발송한다면 좋을 것 같습니다.

3. **시스템 성능 및 확장성 확보**
    - **많은 사용자가 몰려와도** 시스템이 버틸 수 있게 하려면 어떻게 해야 할까요?
		- 많은 사용자에 대한 고가용성 시스템을 구축하기 위해서는 멀티 서버 + 멀티 인스턴스 환경 구축을 통해 대규모 트래픽 수용을 할 수 있습니다.
		- 또는, 트랜잭션 관리가 복잡하지만 카프카와 같은 메시지 브로커를 통해 비동기적을 처리로 뒷단 시스템 부하를 줄일 수 있는 방법도 있으르 수 있을 것 같습니다.

## 지시사항
- **명확하고 논리적**으로 답변해주세요.
- 가능한 한 기술 용어와 예시를 사용하여 **자세하고 구체적**으로 설명해주세요.
- 사용하는 **프로그래밍 언어, 프레임워크, 데이터베이스** 등이 있다면 적어주세요.
- 답변 시 불필요한 내용은 제외하고 질문에서 요구하는 사항에 **집중해서** 답변 부탁드립니다.
