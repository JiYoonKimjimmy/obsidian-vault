
## System Design Interview

### 개발 프로젝트 중 시스템 디자인
- 서비스 오픈 미정이지만, 거래 트랜잭션이란 도메인 개발을 할 수 있었던 외환 계좌 관리 시스템
- 외화 거래를 위한 외화 계좌 관리
- 외화 계좌 기준 수기 및 실시간 입출금 거래 트랜잭션 관리
- 환율 정보 제공을 위한 Batch 성 환율 정보 수집 및 제공

#### 외화 계좌 관리
- 등록/수정
- 조회
- 외화 계좌의 경우 외환 담당자가 백오피스 어드민에서 수기 관리

#### 외화 거래 관리

##### 수기 입출금 거래 관리
- 외환 담당자가 백오피스 어드민에서 외화 예치금 계좌 정보와 함께 금액 입력 및 입출금 거래 요청
- 수기 입금 거래
	1. 거래 요청 계좌 상태 검증 (공통)
		1. 존재 여부
		2. ACTIVE 상태 여부
	2. 입금 계좌 정보 변경 with 분산락
		1. 잔액 증액
		2. 평균 환율 변경
	3. 수기 입금 거래 내역 생성 Event 발행
- 수기 출금 거래
	1. 거래 요청 계좌 상태 검증 (공통)
	2. 출금 계좌 출금 한도 확인 (공통)
		1. 출금 준비 거래 금액 합계 조회 (from Cache)
		2. `출금 요청 금액 + 출금 준비 거래 금액 합계 < 출금 계좌 잔액` 조건 확인
	3. 출금 계좌 정보 변경 `with 분산락`
		1. 잔액 감액
	4. 수기 출금 거래 내역 생성 Event 발행

##### 거래 내역 생성 Event 처리
1. 거래 내역 생성 Application Event 발행
2. Event 수신하여 거래 내역 DB 저장
	1. DB 저장 실패하는 경우, RabbitMQ 만료 시간 TTL 5000ms Message 발행
	2. RabbitMQ Dead-Letter Queue 발행/수신하여 거래 내역 DB 저장 재시도

##### 실시간 출금 거래 관리
- 해외 송금과 같은 서비스에서 요청되어 실시간 외화 예치금 계좌 출금 거래
- 출금 대기 거래와 출금 완료 거래 구분하여 실시간 출금 거래 진행
- 실시간 출금 대기 거래
	1. 거래 요청 계좌 상태 검증 (공통)
	2. 출금 계좌 출금 한도 확인 (공통)
	3. 출금 대기 거래 Cache 저장
		1. 요청 `거래참조ID` key 기준 출금 대기 거래 Caching 처리
		2. 거래 요청 계좌의 `계좌번호` key 기준 출금 대기 거래 금액 합계 Cache 증액 처리 `with 분산락`
	4. 실시간 출금 대기 거래 내역 생성 Event 발행
- 실시간 출금 완료 거래
	1. 요청 `거래참조ID` 기준 출금 대기 거래 존재 여부 확인
		1. Cache & DB 거래 내역 조회 및 존재하지 않는 경우 예외 처리
	2. 거래 요청 계좌 상태 검증 (공통)
	3. 출금 계좌 출금 한도 확인 (공통)
	4. 출금 계좌 정보 변경 `with 분산락`
		1. 잔액 감액
	5. 출금 대기 거래 Cache 정보 삭제
	6. 출금 대기 거래 금액 합계 Cache 감액 처리 `with 분산락`
	7. 실시간 출금 완료 거래 내역 생성 Event 발행

##### Distributed-Lock 분산락 구현 방식
- Redis 를 활용한 분산락 기능 개발
- Redisson 라이브러리 적용하여 지정한 `cache key` 기준 비즈니스 로직 `Lock` 처리
- 분산락을 통해 동시성 제어가 필요한 로직만 자원 공유 제어하도록 구현

##### Event Driven 시스템 구현 방식
- RabbitMQ 활용한 Message Pub/Sub 기반 Event Driven 시스템 구축
- 시스템 장애에 대한 부하 제어를 위해 Message 발행 시 TTL 설정 후 Dead-Letter Exchange Pub/Sub 방식으로 메시지 처리 프로세스

---

### Review​

#### MSA 관련 질문
- MSA 구조 서비스의 트랜잭션 관리 방법
- 비동기 방식 분산 트랜잭션이 아니더라도, 동기 방식 트랜잭션을 보장할 수 있는 방법 정리 필요
	- 현재 사내 서비스의 트랜잭션 관리 방법은?
#### KAS 서비스 관련 질문
- 레거시 KAS 서비스의 개선 배경 정리
	- 데이터 수집 자동화 프로세스 필요
	- RDBMS 데이터 관리로 인한 조회 성능 이슈
	- 왜 개선을 하게 되었는지 설득력이 충분히 필요!!
- Elasticsearch 도입 사유
	- 주소 조회시 인덱싱 필요
		- 동의어 처리
		- 전체 주소가 아니더라도 정보 검색 가능
	- ES 도입으로 어떤 큰 이점을 가져올 수 있었는가!!
- Elasticsearch 인프라
	- 값비싼 ES 를 온프레미스 구축하였으니, 인프라 구성 확인!
#### TGS 관련
- 코어 서버 장애 대응 방법 정리
- 인메모리DB 장애 대응 방안 정리
- 시스템 모니터링 집계 데이터 정리