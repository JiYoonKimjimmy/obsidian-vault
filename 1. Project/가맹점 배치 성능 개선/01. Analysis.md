## ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¶„ì„

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

1. SFTP ì „ë¬¸ ìˆ˜ì‹ í•˜ì—¬ ê°€ë§¹ì  ë°ì´í„° ì €ì¥ ì²˜ë¦¬ 
	1. `ê°€ë§¹ì ë²ˆí˜¸` ê¸°ì¤€ KB ê°€ë§¹ì  DB ì¡°íšŒ
		1. ê¸°ì¡´ ì •ë³´ ìˆëŠ” ê²½ìš°, ì •ë³´ ë³€ê²½
		2. ê¸°ì¡´ ì •ë³´ ì—†ëŠ” ê²½ìš°, ì‹ ê·œ ë“±ë¡
	2. `KB_MERCHANT` í…Œì´ë¸” DB ì €ì¥
	3. `KB_MERCHANT_HISTORY` í…Œì´ë¸” DB ì €ì¥
2. `MERCHANT_CHANGE_NOTICE` í…Œì´ë¸” DB ì €ì¥
3. ê°€ë§¹ì  ì£¼ì†Œ ê¸°ì¤€ `KAS` ì¢Œí‘œ ì •ë³´ ì¡°íšŒí•˜ì—¬ ë°ì´í„° ì €ì¥ ì²˜ 
4. ê°€ë§¹ì  ì €ì¥ ì²˜ë¦¬ í›„ `LBMS` ê°€ë§¹ì  ë“±ë¡ ìš”ì²­ ì²˜ë¦¬

#### 1ì°¨ ì„±ëŠ¥ ê°œì„ 
##### ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ê¸°ì¤€ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼
- ë‹¨ì¼ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 1ì´ˆ
- 1000ê±´ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 110ì´ˆ

| RECORD_COUNT |  DURATION |
| -----------: | --------: |
|            1 |   1263 ms |
|            2 |   1017 ms |
|         1000 | 114826 ms |
##### ê°œì„  ì‚¬í•­
- `LBMS` ê°€ë§¹ì  ë“±ë¡ API ìš”ì²­ì„ í•˜ê¸° ìœ„í•œ ApplicationEvent ë‹¨ê±´ ë°œí–‰ ë¶€ë¶„ ìˆ˜ì •
	- chunk size ë§Œí¼ì˜ ê°€ë§¹ì  ë°ì´í„°ë¥¼ ë‹¤ê±´ Event ë°œí–‰ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
###### ê°œì„  ê²°ê³¼
- ë‹¨ì¼ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 0.8ì´ˆ
- 1000ê±´ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 110ì´ˆ

| RECORD_COUNT |  DURATION |
| -----------: | --------: |
|            1 |    848 ms |
|            2 |   1165 ms |
|         1000 | 111279 ms |

----

#### 2ì°¨ ì„±ëŠ¥ ê°œì„ 

##### ê°œì„  ì‚¬í•­
- `KB_MERCHANT`, `KB_MERCHANT_HISTORY` Entity ì •ë³´ ì‹ ê·œ ë“±ë¡ & ë³€ê²½í•˜ì—¬ ì‹ ê·œ Entity ìƒì„± í›„ ë‹¨ê±´ `save` ì²˜ë¦¬ ë¶€ë¶„ ìˆ˜ì •
	- `List<Entity>` íƒ€ì…ìœ¼ë¡œ `saveAll` ë‹¤ê±´ ì €ì¥ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
	- í•˜ì§€ë§Œ, ì„±ëŠ¥ ì¸¡ë©´ í° ì°¨ì´ëŠ” ì—†ëŠ” ë“¯.. ğŸ˜¥
- `LBMS` ê°€ë§¹ì  ë“±ë¡ API ë¹„ë™ê¸° ì²˜ë¦¬
	- 1000ê±´ ì²˜ë¦¬ ì†Œìš” ì‹œê°„ ì¤‘ `LBMS` API ìš”ì²­ ì²˜ë¦¬ ì†Œìš” ì‹œê°„ 30ì´ˆ ê°€ëŸ‰
	- ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ API ìš”ì²­í•˜ë„ë¡ ìˆ˜ì •
	- `CompletableFuture` í™œìš©í•œ ë¹„ë™ê¸° ì½”ë“œ êµ¬í˜„
		- `CompletableFuture` ë¹„ë™ê¸° ì½”ë“œ êµ¬í˜„ ì£¼ì˜ ì‚¬í•­
			- ë¹„ë™ê¸° ì½”ë“œ ëŸ°íƒ€ì„ ì˜ˆì™¸ì— ëŒ€í•œ ë¡œê·¸ ì¶œë ¥ ë“± ë³„ë„ ì˜ˆì™¸ ì²˜ë¦¬ í•„ìš”
			- Thread Pool ê´€ë¦¬ 
				- Thread Pool í¬ê¸° ì„¤ì • ë°©ì‹
					- CPU ë°”ìš´ë“œ ì‘ì—… : CPU ì‚¬ìš©ëŸ‰ í° ì‘ì—…ì¸ ê²½ìš°, ìŠ¤ë ˆë“œ-í’€ í¬ê¸°ë¥¼ CPU ì½”ì–´ ìˆ˜ì™€ ë¹„ìŠ·í•˜ê²Œ ì„¤ì •í•˜ë„ë¡ ê¶Œì¥ > `N_CPU + 1`
					- I/O ë°”ìš´ë“œ ì‘ì—… : I/O ì‚¬ìš©ëŸ‰ í° ì‘ì—…ì¸ ê²½ìš°, ìŠ¤ë ˆë“œ ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë¯€ë¡œ ë” ë§ì€ ìŠ¤ë ˆë“œ í™•ë³´ê°€ í•„ìš” > `N_CPU * 2` or `N_CPU * 2 + 1`
				- `int nThreads = Runtime.getRuntime().availableProcessors() * 2;` ì½”ë“œë¥¼ í†µí•´ ìŠ¤ë ˆë“œ-í’€ í¬ê¸° ì„¤ì •
				- Thread Pool ëª…ì‹œì  ì¢…ë£Œ ì²˜ë¦¬ í•„ìš”

```java
ExecutorService executor = Executors.newFixedThreadPool(nThreads);
// ...ë¹„ë™ê¸° ì²˜ë¦¬...
executor.shutdown();
```

###### ê°œì„  ê²°ê³¼
- ë‹¨ì¼ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 0.9ì´ˆ
- 1000ê±´ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 70ì´ˆ

| RECORD_COUNT | DURATION |
| -----------: | -------: |
|            1 |   933 ms |
|            2 |  1022 ms |
|         1000 | 68391 ms |

---

#### 3ì°¨ ê°œì„ 

##### ê°œì„  ì‚¬í•­
- ItemWriter ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°œì„ 
	- 1000 ê±´ ê¸°ì¤€
		- KbMerchant ë°ì´í„° ê°€ê³µ ì†Œìš” ì‹œê°„ : 65694 ms
		- DB `save` ì²˜ë¦¬ ì†Œìš” ì‹œê°„ : 5050 ms
	- `items` ìˆœíšŒí•˜ë©´ì„œ ê¸°ì¡´ ê°€ë§¹ì  ì •ë³´ ë‹¨ê±´ ì¡°íšŒ
		- `items` `mctMngNo` 1000ê±´ì”© ë¶„ë¦¬í•˜ì—¬ ê¸°ì¡´ ê°€ë§¹ì  ì •ë³´ ë‹¤ê±´ ì¡°íšŒ > `Map<String, KbMerchant>` ì»¬ë ‰ì…˜ íƒ€ì…
		- `Map<String, KbMerchant>` ì»¬ë ‰ì…˜ìœ¼ë¡œ `mctMngNo` key ê¸°ì¤€ ê¸°ì¡´ ê°€ë§¹ì  ì •ë³´ì™€ ë³€ê²½ ì •ë³´ ì—…ë°ì´íŠ¸ ì²˜ë¦¬í•˜ë„ë¡ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜ì •
		- ê²°ê³¼ : 10ì´ˆ ê°€ëŸ‰ ì„±ëŠ¥ ê°œì„ 
- DB ì‹œí€€ìŠ¤ ì±„ë²ˆ ë¡œì§ ê°œì„  > ë³„ ì°¨ì´ê°€ ì—†ìŒ..

---

#### 4ì°¨ ê°œì„ 

##### ê°œì„  ì‚¬í•­
- Spring Batch Partitioning ë³‘ë ¬ ì²˜ë¦¬
- í˜„ì¬ ê°€ìš© Thread ìˆ˜ì˜ ì ˆë°˜ ì„¤ì •í•˜ì—¬ Step Partitioning ë³‘ë ¬ ì²˜ë¦¬
- Partitioning ì²˜ë¦¬ë¥¼ ìœ„í•´ íŒŒì¼ì„ ì‚¬ì „ì— í•œë²ˆ ë” ì½ê³  íŒŒí‹°ì…˜ì„ êµ¬ë¶„í•˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ ë‹¨ì¼ Step ì²˜ë¦¬ë³´ë‹¨ ê¸°ë³¸ì ì¸ ì²˜ë¦¬ ì†Œìš” ì‹œê°„ì´ ì¦ê°€í•˜ì§€ë§Œ,
- ìµœì¢…ì ì¸ ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì†Œìš” ì‹œê°„ì—ì„œëŠ” í›¨ì”¬ ë” ë¹ ë¥¸ ì‹œê°„ ë‚´ ì²˜ë¦¬ ê°€ëŠ¥

> Spring Batch Partitioning ê´€ë ¨ ë¸”ë¡œê·¸ : https://jojoldu.tistory.com/550

###### ê°œì„  ê²°ê³¼
- ë‹¨ì¼ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 1.2ì´ˆ
- 1000ê±´ ë°ì´í„° ì²˜ë¦¬ ì†ë„ í‰ê·  : 22ì´ˆ

| RECORD_COUNT | DURATION |
| -----------: | -------: |
|            1 |  1244 ms |
|            2 |  1252 ms |
|         1000 | 15267 ms |

---
###### TaskExecutor ì„¤ì •

```java
@Bean  
public ThreadPoolTaskExecutor taskExecutor() {  
    int availableProcessors = Runtime.getRuntime().availableProcessors() / 2;  
    log.info("Available Processors: {}", availableProcessors);  
  
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();  
    executor.setCorePoolSize(availableProcessors);      // ê°€ìš© í”„ë¡œì„¸ì„œ ìˆ˜ë¡œ ì„¤ì •  
    executor.setMaxPoolSize(availableProcessors);       // ìµœëŒ€ ìŠ¤ë ˆë“œ ìˆ˜ ì„¤ì •  
    executor.setQueueCapacity(availableProcessors * 5); // ìŠ¤ë ˆë“œ í’€ í—ˆìš© task ìˆ˜ ì„¤ì •  
    executor.setWaitForTasksToCompleteOnShutdown(true); // ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°  
    executor.setAwaitTerminationSeconds(30);            // ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì„¤ì •  
    executor.initialize();  
    return executor;  
}
```

###### Partitioner ì„¤ì •

```java
@Slf4j  
public class SaveKbMerchantPartitioner implements Partitioner {  
  
    private final KbMerchantOriginFileService fileService;  
  
    public SaveKbMerchantPartitioner(KbMerchantOriginFileService fileService) {  
        this.fileService = fileService;  
    }  
  
    @Override  
    public Map<String, ExecutionContext> partition(int gridSize) {  
        Map<String, ExecutionContext> partitions = new HashMap<>();  
        int totalLines = 0;  
        try {  
            Resource resource = new PathResource(fileService.getFileName(MERCHANT));  
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(resource.getInputStream()))) {  
                while (reader.readLine() != null) {  
                    totalLines++;  
                }  
            }  
  
            int targetSize = totalLines / gridSize + (totalLines % gridSize == 0 ? 0 : 1);  
            int start = 0;  
            int end = targetSize;  
  
            for (int i = 0; i < gridSize; i++) {  
                ExecutionContext context = new ExecutionContext();  
                context.putInt("start", start);  
                context.putInt("end", Math.min(end, totalLines));  
                partitions.put("partition" + i, context);  
  
                start = end;  
                end += targetSize;  
            }  
        } catch (Exception e) {  
            log.error(e.getMessage(), e);  
        }  
        return partitions;  
    }  
  
}
```

###### Step Config ì„¤ì •

```java
@Slf4j  
@RequiredArgsConstructor  
@Configuration  
public class SaveKbMerchantStepConfig {  
  
    private final StepBuilderFactory stepBuilderFactory;  
    private final SaveKbMerchantWriter writer;  
    private final KbStepListener kbStepListener;  
    private final KbMerchantOriginFileService fileService;  
    private final ReportService reportService;  
  
    private final ThreadPoolTaskExecutor taskExecutor;  
  
    @Bean  
    public PartitionHandler partitionHandler() {  
        TaskExecutorPartitionHandler handler = new TaskExecutorPartitionHandler();  
        handler.setTaskExecutor(taskExecutor);  
        handler.setStep(slaveStep());  
        handler.setGridSize(taskExecutor.getCorePoolSize());  
        return handler;  
    }  
  
    @Bean  
    public Step saveMerchantStep() {  
        return stepBuilderFactory.get(MERCHANT.getStepName())  
                .partitioner(slaveStep().getName(), new SaveKbMerchantPartitioner(fileService))  
                .partitionHandler(partitionHandler())  
                .listener(kbStepListener)  
                .build();  
    }  
  
    @Bean  
    public Step slaveStep() {  
        return stepBuilderFactory.get("slaveStep")  
                .<KbMerchantOriginBase, KbMerchant>chunk(1000)  
                .reader(new SaveKbMerchantReader(reportService, fileService))  
                .processor(new SaveKbMerchantProcessor(reportService))  
                .writer(writer)  
                .build();  
    }  
  
}
```
 
##### ì£¼ì˜ ì‚¬í•­: ê¸°ì¡´ `LBMS` API ë°œì†¡ ë³‘ë ¬ ì²˜ë¦¬ ì œê±°
 - Thread Pool ì´ˆê³¼ë¡œ ì¸í•´ HTTP Connection Time-out ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
 - ê°œë°œ í™˜ê²½ ê¸°ì¤€ ë³‘ë ¬ ì²˜ë¦¬ ì‹œ 1000ê±´ ì²˜ë¦¬ ê¸°ì¤€ 2ì´ˆ ì†Œìš” ì‹œê°„ì´ 8ì´ˆë¡œ ë³€ê²½ë˜ë‚˜,
 - Partitioning ë³‘ë ¬ ì²˜ë¦¬ì˜ íš¨ê³¼ê°€ ë”ìš± ë›°ì–´ë‚˜ê¸°ì— `LBMS` API ë°œì†¡ ë³‘ë ¬ ì²˜ë¦¬ëŠ” ì œê±°..!

##### ì£¼ì˜ ì‚¬í•­: Batch ì²˜ë¦¬ ê±´ìˆ˜ Count ë¡œì§ ë³€ê²½
- Step ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì¸í•´ `itemCountProcessed` ì™€ ê°™ì€ ê±´ìˆ˜ ë³€ìˆ˜ì— ìì› ê³µìœ  ë°œìƒ
- ìì› ê³µìœ  ë°©ì§€ë¥¼ ìœ„í•´ `Â CAS(Compare-And-Swap) ì—°ì‚°` í•˜ëŠ” `AtomicLong` íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì²˜ë¦¬

> `CAS` AI ë‹µë³€ : CAS(Compare-And-Swap) ì—°ì‚°ì€Â ë©€í‹°ìŠ¤ë ˆë“œÂ í™˜ê²½ì—ì„œÂ ë™ê¸°í™”Â ì—†ì´Â ì•ˆì „í•˜ê²ŒÂ ë³€ìˆ˜ì˜Â ê°’ì„Â ì—…ë°ì´íŠ¸í•˜ê¸°Â ìœ„í•´Â ì‚¬ìš©ë˜ëŠ”Â ì›ìì Â ì—°ì‚°ì…ë‹ˆë‹¤. Javaì˜Â AtomicLongê³¼Â AtomicIntegerÂ í´ë˜ìŠ¤ëŠ”Â ì´ëŸ¬í•œÂ CASÂ ì—°ì‚°ì„Â ë‚´ë¶€ì ìœ¼ë¡œÂ ì‚¬ìš©í•˜ì—¬Â ìŠ¤ë ˆë“œÂ ê°„ì˜Â ê²½ìŸÂ ì¡°ê±´ì„Â ë°©ì§€í•˜ê³ , ë½ì„Â ì‚¬ìš©í•˜ì§€Â ì•Šê³ ë„Â ì•ˆì „í•˜ê²ŒÂ ê°’ì„Â ë³€ê²½í• Â ìˆ˜Â ìˆë„ë¡Â í•©ë‹ˆë‹¤.

---
