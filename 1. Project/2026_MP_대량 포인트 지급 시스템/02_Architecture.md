
# ğŸ—ï¸ ëŒ€ëŸ‰ í¬ì¸íŠ¸ ì§€ê¸‰ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ“Œ Overview

> [!info] ë¬¸ì„œ ëª©ì 
> ëŒ€ëŸ‰ í¬ì¸íŠ¸ ì§€ê¸‰ ì‹œìŠ¤í…œì˜ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë¬¸ì„œ
> - ìš”êµ¬ ì‚¬í•­: [[01_Requirement]]

### ì•„í‚¤í…ì²˜ ì„ íƒ: Chunk + Partitioning í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹

> [!tip] ì„ íƒ ì´ìœ 
> - Outbox í…Œì´ë¸” 100ë§Œ row ì ì¬ ë¶€ë‹´ ì œê±°
> - íŒŒí‹°ì…”ë‹ì„ í†µí•œ ë³‘ë ¬ ì²˜ë¦¬ë¡œ ê³ ì„±ëŠ¥ ë‹¬ì„±
> - Chunk ë‹¨ìœ„ ì œì–´ë¡œ ìº í˜ì¸ ì¤‘ë‹¨ ìš©ì´

### ì•„í‚¤í…ì²˜ ë¹„êµ

| ë°©ì‹                               | ì¥ì                         | ë‹¨ì                              |  ì¶”ì²œë„  |
| -------------------------------- | ------------------------- | ------------------------------ | :---: |
| Transactional Outbox             | ë°ì´í„° ì¼ê´€ì„± ë³´ì¥, At-least-once | Outbox í…Œì´ë¸” ê´€ë¦¬ ë¶€ë‹´, Polling ì˜¤ë²„í—¤ë“œ |  â­â­â­  |
| Outbox + CDC (Debezium)          | ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìº¡ì²˜                | ì¸í”„ë¼ ë³µì¡ë„ ì¦ê°€                     | â­â­â­â­  |
| ì§ì ‘ Kafka ë°œí–‰                      | ë‹¨ìˆœí•¨                       | DB-Kafka ë¶ˆì¼ì¹˜ ê°€ëŠ¥                |  â­â­   |
| **í•˜ì´ë¸Œë¦¬ë“œ (Chunk + Partitioning)** | Outbox ë¶ˆí•„ìš”, ì§ì ‘ ì œì–´ ê°€ëŠ¥      | ë©±ë“±ì„± í•„ìˆ˜                         | â­â­â­â­â­ |

---

## ğŸ›ï¸ High-Level Architecture

```mermaid
flowchart TB
    subgraph Scheduler["ğŸ• Scheduler"]
        A[ìº í˜ì¸ ì‹œì‘ ìš”ì²­]
    end
    
    subgraph Publisher["ğŸ“¤ Publisher (Multi-Worker)"]
        B[Worker 0<br/>partition_key=0]
        C[Worker 1<br/>partition_key=1]
        D[Worker 2<br/>partition_key=2]
        E[Worker 3<br/>partition_key=3]
    end
    
    subgraph DB["ğŸ’¾ Database"]
        F[(payment_target<br/>+ partition_key<br/>+ publish_status)]
    end
    
    subgraph Cache["ğŸ“Š Redis"]
        R[ì§€ê¸‰ í˜„í™© ì¹´ìš´íŠ¸<br/>total/published/success/fail]
    end
    
    subgraph Kafka["ğŸ“¨ Kafka Topic: payment-request"]
        G0[Partition 0]
        G1[Partition 1]
        G2[Partition 2]
        G3[Partition 3]
    end
    
    subgraph Consumer["ğŸ“¥ Consumer Group"]
        H[Consumer 0]
        I[Consumer 1]
        J[Consumer 2]
        K[Consumer 3]
    end
    
    subgraph Idempotency["ğŸ” ë©±ë“±ì„± ê³„ì¸µ"]
        L[DB Unique Constraint]
    end
    
    subgraph External["ğŸŒ External"]
        M[money API]
    end
    
    A --> B & C & D & E
    A -->|total count| R
    F --> B & C & D & E
    B -->|partition: 0| G0
    C -->|partition: 1| G1
    D -->|partition: 2| G2
    E -->|partition: 3| G3
    B & C & D & E -->|published count| R
    G0 --> H
    G1 --> I
    G2 --> J
    G3 --> K
    H & I & J & K --> L
    H & I & J & K -->|success/fail count| R
    L --> M
```

> [!tip] ì²˜ë¦¬ ê²½ë¡œ ì¼ê´€ì„±
> **Worker N â†’ Partition N â†’ Consumer N** ê²½ë¡œê°€ í™•ì •ë¨
> - DB partition_keyë¥¼ Kafka Partitionìœ¼ë¡œ ì§ì ‘ ì§€ì •
> - í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ë¶ˆì¼ì¹˜ ë¬¸ì œ ì›ì²œ í•´ê²°

### ì»´í¬ë„ŒíŠ¸ ì—­í• 

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  | ë¹„ê³  |
|----------|------|------|
| **Scheduler** | ìº í˜ì¸ ì‹œì‘/ì¤‘ë‹¨ íŠ¸ë¦¬ê±°, ì „ì²´ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” | Admin API ë˜ëŠ” ë°°ì¹˜ |
| **Publisher** | DB ì¡°íšŒ â†’ Kafka ë°œí–‰, ë°œí–‰ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ | partition_keyë¡œ Kafka íŒŒí‹°ì…˜ ì§ì ‘ ì§€ì • |
| **Kafka** | ë©”ì‹œì§€ ë¸Œë¡œì»¤ | íŒŒí‹°ì…˜ë³„ ìˆœì„œ ë³´ì¥ |
| **Consumer** | ë©”ì‹œì§€ ì†Œë¹„ â†’ money API í˜¸ì¶œ, ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ | Consumer Group |
| **Redis** | ì‹¤ì‹œê°„ ì§€ê¸‰ í˜„í™© ì¹´ìš´íŠ¸ ê´€ë¦¬ | total, published, success, fail |
| **ë©±ë“±ì„± ê³„ì¸µ** | ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ | DB Unique Constraint |

---

## ğŸ”„ ì²˜ë¦¬ íë¦„

### ì „ì²´ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
sequenceDiagram
    participant S as Scheduler
    participant P as Publisher Worker
    participant DB as Database
    participant K as Kafka
    participant C as Consumer
    participant M as money API
    participant DLT as DLT Topic
    participant RC as RetryConsumer
    participant R as Redis

    S->>P: ìº í˜ì¸ í¬ì¸íŠ¸ ì§€ê¸‰ ì‹œì‘ ìš”ì²­
    S->>DB: INSERT payment_summary (campaign_id, total_count, started_at)
    S->>R: í¬ì¸íŠ¸ ì§€ê¸‰ 'ì „ì²´' ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    
    loop Chunk ë‹¨ìœ„ ì²˜ë¦¬ (1000ê±´ì”©)
        P->>DB: SELECT (partition_key=N, publish_status=PENDING)<br/>LIMIT 1000
        DB-->>P: ì§€ê¸‰ ëŒ€ìƒ ëª©ë¡
        P->>K: Batch ë©”ì‹œì§€ ë°œí–‰
        P->>DB: UPDATE publish_status=PUBLISHED
        P->>R: í¬ì¸íŠ¸ ì§€ê¸‰ 'ë°œí–‰' ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    end
    
    K->>C: ë©”ì‹œì§€ ìˆ˜ì‹ 
    C->>DB: ìº í˜ì¸ ìƒíƒœ ì²´í¬ (Cache í™œìš©)
    
    alt ìº í˜ì¸ ìƒíƒœ = ì§„í–‰
        C->>DB: INSERT payment_result (ë©±ë“±ì„±)
        alt ì‹ ê·œ ê±´
            C->>M: í¬ì¸íŠ¸ ì§€ê¸‰ ìš”ì²­
            alt ì§€ê¸‰ ì„±ê³µ
                M-->>C: ì„±ê³µ ì‘ë‹µ
                C->>DB: UPDATE status=SUCCESS
                C->>R: í¬ì¸íŠ¸ ì§€ê¸‰ 'ì„±ê³µ' ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            else ì§€ê¸‰ ì‹¤íŒ¨
                M-->>C: ì‹¤íŒ¨ ì‘ë‹µ
                C->>DB: UPDATE status=FAILED
                C->>DLT: DLT ë°œí–‰ (retryCount++)
                C->>R: í¬ì¸íŠ¸ ì§€ê¸‰ 'ì‹¤íŒ¨' ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            end
        else ì´ë¯¸ ì²˜ë¦¬ëœ ê±´ (DuplicateKey)
            C->>C: Skip
        end
    else ìº í˜ì¸ ìƒíƒœ â‰  ì§„í–‰
        C->>C: ë©”ì‹œì§€ íê¸°
    end
    
    Note over DLT,RC: ì¬ì²˜ë¦¬ íë¦„
    DLT->>RC: ë©”ì‹œì§€ ìˆ˜ì‹ 
    RC->>RC: ì§€ì—° ëŒ€ê¸° (Exponential Backoff)
    RC->>M: í¬ì¸íŠ¸ ì§€ê¸‰ ì¬ì‹œë„
    alt ì¬ì‹œë„ ì„±ê³µ
        M-->>RC: ì„±ê³µ ì‘ë‹µ
        RC->>DB: UPDATE status=SUCCESS
        RC->>R: í¬ì¸íŠ¸ ì§€ê¸‰ 'ì„±ê³µ' ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    else ì¬ì‹œë„ ì‹¤íŒ¨ (retryCount < 5)
        M-->>RC: ì‹¤íŒ¨ ì‘ë‹µ
        RC->>DLT: DLT ì¬ë°œí–‰
    else ì¬ì‹œë„ í•œë„ ì´ˆê³¼ (retryCount >= 5)
        M-->>RC: ì‹¤íŒ¨ ì‘ë‹µ
        RC->>DB: UPDATE status=PERMANENTLY_FAILED
    end
```

### Publisher ì²˜ë¦¬ íë¦„

```mermaid
flowchart TB
    A[ìº í˜ì¸ ì‹œì‘] --> B{ìº í˜ì¸ ìƒíƒœ<br/>= ì§„í–‰?}
    B -->|No| C[ì¢…ë£Œ]
    B -->|Yes| D[ë‹´ë‹¹ íŒŒí‹°ì…˜ ì¡°íšŒ<br/>PENDING ìƒíƒœ 1000ê±´]
    D --> E{ë°ì´í„°<br/>ì¡´ì¬?}
    E -->|No| F[ì™„ë£Œ ì²˜ë¦¬]
    E -->|Yes| G[Kafka Batch ë°œí–‰]
    G --> H[publish_status<br/>= PUBLISHED ì—…ë°ì´íŠ¸]
    H --> I[ğŸ“Š Redis<br/>ë°œí–‰ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸]
    I --> J{ìº í˜ì¸ ìƒíƒœ<br/>= ì§„í–‰?}
    J -->|Yes| D
    J -->|No| C
```

### Consumer ì²˜ë¦¬ íë¦„ (PaymentConsumer)

```mermaid
flowchart TB
    A[ë©”ì‹œì§€ ìˆ˜ì‹ <br/>payment-request] --> B{ìº í˜ì¸ ìƒíƒœ<br/>= ì§„í–‰?}
    B -->|No| C[ğŸš« ë©”ì‹œì§€ íê¸°]
    B -->|Yes| D[payment_result<br/>INSERT ì‹œë„]
    D --> E{DuplicateKey<br/>Exception?}
    E -->|Yes| F[âœ… Skip<br/>ì´ë¯¸ ì²˜ë¦¬ë¨]
    E -->|No| G[money API í˜¸ì¶œ]
    G --> H{ì§€ê¸‰ ì„±ê³µ?}
    H -->|Yes| I[âœ… status = SUCCESS]
    I --> I2[ğŸ“Š Redis<br/>ì„±ê³µ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸]
    H -->|No| J[retryCount++<br/>errorMessage ì„¤ì •]
    J --> K[ğŸ“¤ DLT ë°œí–‰<br/>payment-request.DLT]
    K --> K2[ğŸ“Š Redis<br/>ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸]
```

### RetryConsumer ì²˜ë¦¬ íë¦„

```mermaid
flowchart TB
    A[ë©”ì‹œì§€ ìˆ˜ì‹ <br/>payment-request.DLT] --> B[ì§€ì—° ëŒ€ê¸°<br/>Exponential Backoff]
    B --> C[money API ì¬í˜¸ì¶œ]
    C --> D{ì§€ê¸‰ ì„±ê³µ?}
    D -->|Yes| E[âœ… status = SUCCESS]
    E --> E2[ğŸ“Š Redis<br/>ì„±ê³µ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸]
    D -->|No| F{retryCount < 5?}
    F -->|Yes| G[retryCount++]
    G --> H[ğŸ“¤ DLT ì¬ë°œí–‰<br/>payment-request.DLT]
    F -->|No| I[ğŸš¨ Final DLT ë°œí–‰<br/>payment-request.DLT.FINAL]
    I --> J[status = PERMANENTLY_FAILED]
    J --> K[ì•Œë¦¼ ë°œì†¡]
```

---

## ğŸ“¦ Kafka ë©”ì‹œì§€ êµ¬ì¡°

### ë©”ì‹œì§€ ì„¤ê³„ ë°©ì‹: Fat Message

> [!note] Fat Message ì„ íƒ ì´ìœ 
> - Consumerì—ì„œ DB ì¡°íšŒ ë¶ˆí•„ìš” (ì„±ëŠ¥ í–¥ìƒ)
> - ë°œí–‰ ì‹œì  ë°ì´í„° ê³ ì • (ê°ì‚¬ ì¶”ì  ìš©ì´)
> - ë©”ì‹œì§€ë§Œìœ¼ë¡œ ì¬ì²˜ë¦¬ ê°€ëŠ¥

### ë©”ì‹œì§€ ìŠ¤í‚¤ë§ˆ

```json
{
  "messageId": "550e8400-e29b-41d4-a716-446655440000",
  "targetId": 12345,
  "campaignId": "C001",
  "memberId": "M12345",
  "amount": 1000,
  "reason": "ì‹ ë…„ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ ì§€ê¸‰",
  "publishedAt": "2026-01-15T10:30:00Z"
}
```

### í•„ë“œ ì„¤ëª…

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `messageId` | UUID | ë©”ì‹œì§€ ê³ ìœ  ì‹ë³„ì |
| `targetId` | Long | payment_target í…Œì´ë¸” PK |
| `campaignId` | String | ìº í˜ì¸ ì‹ë³„ì |
| `memberId` | String | íšŒì› ì‹ë³„ì |
| `amount` | Long | ì§€ê¸‰ ê¸ˆì•¡ |
| `reason` | String | ì§€ê¸‰ ì‚¬ìœ  |
| `publishedAt` | ISO8601 | ë°œí–‰ ì‹œê° |

> [!tip] ë©±ë“±ì„± í‚¤ëŠ” ë©”ì‹œì§€ì— í¬í•¨í•˜ì§€ ì•ŠìŒ
> `campaign_id + member_id` ì¡°í•©ì€ Consumerì—ì„œ ì§ì ‘ ê³„ì‚°í•˜ë©°, DB Unique Constraintë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

---

## ğŸ”‘ Kafka íŒŒí‹°ì…˜ ë¶„ë°° ì „ëµ

### íŒŒí‹°ì…˜ ì§€ì • ë°©ì‹: DB partition_key ì§ì ‘ ì‚¬ìš©

> [!important] í•µì‹¬ ì„¤ê³„
> - **Kafka Partition**: DBì— ì €ì¥ëœ `partition_key` ê°’ì„ ì§ì ‘ ì§€ì •
> - **Message Key**: `campaign_id + member_id` (íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥ìš©)
> - DB íŒŒí‹°ì…˜ê³¼ Kafka íŒŒí‹°ì…˜ì˜ ì™„ë²½í•œ ì¼ì¹˜ ë³´ì¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”‘ íŒŒí‹°ì…˜ & í‚¤ ì„¤ê³„                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  [Kafka ë°œí–‰ ì‹œ]                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ topic     : payment-request                         â”‚    â”‚
â”‚  â”‚ partition : partition_key (DB ì €ì¥ê°’, ì§ì ‘ ì§€ì •)       â”‚    â”‚
â”‚  â”‚ key       : campaign_id + member_id (ìˆœì„œ ë³´ì¥ìš©)     â”‚    â”‚
â”‚  â”‚ value     : PaymentMessage                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  DB partition_key = 0  â†’  Kafka Partition 0 (í™•ì •)          â”‚
â”‚  DB partition_key = 1  â†’  Kafka Partition 1 (í™•ì •)          â”‚
â”‚  DB partition_key = 2  â†’  Kafka Partition 2 (í™•ì •)          â”‚
â”‚  DB partition_key = 3  â†’  Kafka Partition 3 (í™•ì •)          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì™œ ì§ì ‘ ì§€ì •ì¸ê°€? (í•´ì‹œ ë¶ˆì¼ì¹˜ ë¬¸ì œ í•´ê²°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ ê¸°ì¡´ ë°©ì‹ì˜ ë¬¸ì œì  (í•´ì‹œ ê¸°ë°˜)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  DB partition_key ê³„ì‚°:                                      â”‚
â”‚    Java hashCode() ë˜ëŠ” MySQL CRC32() ì‚¬ìš©                   â”‚
â”‚    â†’ hash("C001M001") % 4 = 0                               â”‚
â”‚                                                             â”‚
â”‚  Kafka partition ê³„ì‚°:                                       â”‚
â”‚    murmur2 í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš© (Kafka ê¸°ë³¸)                      â”‚
â”‚    â†’ murmur2("C001_M001") % 4 = 2  â† ë‹¤ë¥¼ ìˆ˜ ìˆìŒ!            â”‚
â”‚                                                             â”‚
â”‚  ê²°ê³¼:                                                       â”‚
â”‚    Publisher Worker 0 â†’ SELECT partition_key = 0            â”‚
â”‚    Kafka ë°œí–‰ â†’ murmur2(key) = Partition 2ë¡œ ì „ì†¡            â”‚
â”‚    Consumer 2ê°€ ì²˜ë¦¬ â† DB íŒŒí‹°ì…˜ê³¼ ë¶ˆì¼ì¹˜!                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ê°œì„  ë°©ì‹ (ì§ì ‘ ì§€ì •)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Publisher Worker 0 â†’ SELECT partition_key = 0              â”‚
â”‚  Kafka ë°œí–‰ (partition: 0 ì§ì ‘ ì§€ì •)                          â”‚
â”‚  â†’ í™•ì •ì ìœ¼ë¡œ Partition 0ìœ¼ë¡œ ì „ì†¡                             â”‚
â”‚  â†’ Consumer 0ì´ ì²˜ë¦¬                                         â”‚
â”‚                                                             â”‚
â”‚  ì²˜ë¦¬ ê²½ë¡œê°€ ëª…í™•í•˜ê²Œ ì˜ˆì¸¡ ê°€ëŠ¥:                                 â”‚
â”‚  Publisher Worker N â†’ Partition N â†’ Consumer N              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### êµ¬í˜„ ì½”ë“œ

```java
@Component
public class PaymentPublisher {
    
    private final KafkaTemplate<String, PaymentMessage> kafkaTemplate;
    
    public void publish(PaymentTarget target) {
        PaymentMessage message = PaymentMessage.from(target);
        
        // partitionì„ ì§ì ‘ ì§€ì •í•˜ì—¬ ë°œí–‰
        kafkaTemplate.send(
            "payment-request",                                    // topic
            target.getPartitionKey(),                             // partition (DB ì €ì¥ê°’)
            target.getCampaignId() + "_" + target.getMemberId(),  // key (ìˆœì„œ ë³´ì¥)
            message                                               // value
        );
    }
}
```

### í‚¤ ì¼ê´€ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”‘ í‚¤ ì¼ê´€ì„±                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  DB partition_key     : 0, 1, 2, 3 (hash % partitionCount)  â”‚
â”‚  Kafka Partition      : 0, 1, 2, 3 (partition_key ì§ì ‘ ì§€ì •)  â”‚
â”‚  Kafka Message Key    : campaign_id + member_id             â”‚
â”‚  DB Unique Key        : (campaign_id, member_id)            â”‚
â”‚  ë©±ë“±ì„± í‚¤             : campaign_id + member_id              â”‚
â”‚                                                             â”‚
â”‚  â†’ DB íŒŒí‹°ì…˜ = Kafka íŒŒí‹°ì…˜ (ì™„ë²½ ì¼ì¹˜)                         â”‚
â”‚  â†’ Message Key = ë©±ë“±ì„± í‚¤ (ì¼ê´€ì„± ìœ ì§€)                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ì˜ì‚¬í•­

> [!warning] íŒŒí‹°ì…˜ ìˆ˜ ì¼ì¹˜ í•„ìˆ˜
> - DB partition_key ë²”ìœ„: `0 ~ (N-1)`
> - Kafka íŒŒí‹°ì…˜ ìˆ˜: `N`
> - ë¶ˆì¼ì¹˜ ì‹œ `InvalidPartitionException` ë°œìƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ íŒŒí‹°ì…˜ í™•ì¥ ì‹œ ì£¼ì˜                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Kafka íŒŒí‹°ì…˜ 4 â†’ 8 í™•ì¥ ì‹œ:                                   â”‚
â”‚  - ê¸°ì¡´ ë°ì´í„° partition_key (0~3)ëŠ” ê·¸ëŒ€ë¡œ ìœ íš¨               â”‚
â”‚  - ì‹ ê·œ ë°ì´í„°ë§Œ 0~7 ë²”ìœ„ë¡œ ìƒì„±                               â”‚
â”‚  - ì ì§„ì ìœ¼ë¡œ ìƒˆ íŒŒí‹°ì…˜ í™œìš©ë¨                                  â”‚
â”‚                                                             â”‚
â”‚  ê¶Œì¥ ì ˆì°¨:                                                   â”‚
â”‚  1. Kafka íŒŒí‹°ì…˜ í™•ì¥                                         â”‚
â”‚  2. Consumer í™•ì¥                                            â”‚
â”‚  3. ì• í”Œë¦¬ì¼€ì´ì…˜ partitionCount ì„¤ì • ë³€ê²½                      â”‚
â”‚  4. ì‹ ê·œ ìº í˜ì¸ë¶€í„° ìƒˆ íŒŒí‹°ì…˜ ìˆ˜ ì ìš©                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì¥ì  ìš”ì•½

| í•­ëª© | ì„¤ëª… |
|------|------|
| **DB-Kafka ì¼ì¹˜** | partition_keyì™€ Kafka Partition ì™„ë²½ ì¼ì¹˜ |
| **ì˜ˆì¸¡ ê°€ëŠ¥ì„±** | Worker N â†’ Partition N â†’ Consumer N ê²½ë¡œ í™•ì • |
| **ë””ë²„ê¹… ìš©ì´** | ë¬¸ì œ ë°œìƒ ì‹œ ì¶”ì  ê²½ë¡œ ëª…í™• |
| **í•´ì‹œ ë¶ˆì¼ì¹˜ ì œê±°** | ë‹¤ë¥¸ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ì›ì²œ í•´ê²° |
| **ìˆœì„œ ë³´ì¥ ìœ ì§€** | Message Keyë¡œ íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥ |

---

## ğŸ”€ ë³‘ë ¬ ì²˜ë¦¬ ì „ëµ

### íŒŒí‹°ì…”ë‹ (Partitioning)

> [!note] í•µì‹¬ ì›ë¦¬
> ê° Workerê°€ ë‹´ë‹¹í•  ë°ì´í„° ë²”ìœ„ë¥¼ ë¯¸ë¦¬ ë¶„ë¦¬í•˜ì—¬ **ì¤‘ë³µ ì¡°íšŒ ë°©ì§€**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”€ Partition ë¶„ë°° (Worker 4ê°œ ê¸°ì¤€)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Worker 0: partition_key = 0  (ì•½ 25ë§Œ ê±´)                   â”‚
â”‚  Worker 1: partition_key = 1  (ì•½ 25ë§Œ ê±´)                   â”‚
â”‚  Worker 2: partition_key = 2  (ì•½ 25ë§Œ ê±´)                   â”‚
â”‚  Worker 3: partition_key = 3  (ì•½ 25ë§Œ ê±´)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### íŒŒí‹°ì…˜ í‚¤ ìƒì„±

> [!tip] ì„ íƒ: Option C (INSERT ì‹œ ê³„ì‚°)
> - íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì‹œ DDL ë³€ê²½ ì—†ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ë§Œ ìˆ˜ì •
> - ìº í˜ì¸ë³„ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ìˆ˜ ì ìš© ê°€ëŠ¥
> - ìƒì„¸ ë‚´ìš©: [[#ğŸ“ ë¶€ë¡: partition_key ìƒì„± ì „ëµ|ë¶€ë¡: partition_key ìƒì„± ì „ëµ]] ì°¸ì¡°

```java
// INSERT ì‹œ partition_key ê³„ì‚°
public void savePaymentTarget(PaymentTarget target, int partitionCount) {
    String hashSource = target.getCampaignId() + target.getMemberId();
    int partitionKey = Math.abs(hashSource.hashCode()) % partitionCount;
    target.setPartitionKey(partitionKey);
    
    paymentTargetRepository.save(target);
}
```

### Publisher ì¿¼ë¦¬

```sql
-- Worker 0ì˜ Chunk ì¡°íšŒ
SELECT * FROM payment_target 
WHERE campaign_id = :campaignId 
  AND partition_key = 0
  AND publish_status = 'PENDING'
ORDER BY id
LIMIT 1000;

-- ë°œí–‰ ì™„ë£Œ ë§ˆí‚¹
UPDATE payment_target 
SET publish_status = 'PUBLISHED', 
    updated_at = NOW()
WHERE id IN (:publishedIds);
```

---

## ğŸ” ë©±ë“±ì„± ë³´ì¥ ì „ëµ

### ë‹¨ì¼ ê³„ì¸µ êµ¬ì¡°: DB Unique Constraint

> [!note] ê°„ì†Œí™” ë°°ê²½
> - DB partition_keyë¥¼ Kafka Partitionìœ¼ë¡œ ì§ì ‘ ì§€ì • â†’ **Worker N â†’ Partition N â†’ Consumer N ê²½ë¡œ í™•ì •**
> - Message Key(`campaign_id + member_id`)ë¡œ íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥
> - **DB Unique Constraint ë‹¨ì¼ ê³„ì¸µìœ¼ë¡œ ì¶©ë¶„**
> - ì™¸ë¶€ ì„œë¹„ìŠ¤(money API) ì˜ì¡´ì„± ì œê±°ë¡œ ê²°í•©ë„ ê°ì†Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ë©±ë“±ì„± ë³´ì¥ êµ¬ì¡°                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DB Unique Constraint (campaign_id + member_id)             â”‚
â”‚  â†’ INSERT ì‹œë„ ì‹œ ì¤‘ë³µì´ë©´ DuplicateKeyException ë°œìƒ            â”‚
â”‚  â†’ ì˜ˆì™¸ ì²˜ë¦¬ë¡œ Skip í•˜ì—¬ ë©±ë“±ì„± ë³´ì¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ì™œ ë‹¨ì¼ ê³„ì¸µìœ¼ë¡œ ì¶©ë¶„í•œê°€?                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Kafka íŒŒí‹°ì…˜ ì§ì ‘ ì§€ì • + Message Key ìˆœì„œ ë³´ì¥               â”‚
â”‚     - Partition: DB partition_keyë¡œ ì§ì ‘ ì§€ì •                  â”‚
â”‚     - Message Key: campaign_id + member_id                   â”‚
â”‚     â†’ ê°™ì€ íšŒì› ë©”ì‹œì§€ëŠ” ê°™ì€ íŒŒí‹°ì…˜ â†’ ê°™ì€ Consumer               â”‚
â”‚     â†’ íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥ìœ¼ë¡œ ë™ì‹œ ì²˜ë¦¬ ë¶ˆê°€                         â”‚
â”‚                                                             â”‚
â”‚  2. DB Unique Constraint                                    â”‚
â”‚     â†’ Consumer ë¦¬ë°¸ëŸ°ì‹±, ë©”ì‹œì§€ ì¬ë°œí–‰ ì‹œì—ë„ ì¤‘ë³µ ë°©ì§€              â”‚
â”‚     â†’ ì–´ë–¤ ì˜ˆì™¸ ìƒí™©ì—ì„œë„ ì¤‘ë³µ INSERT ì›ì²œ ì°¨ë‹¨                    â”‚
â”‚                                                             â”‚
â”‚  â€» ì™¸ë¶€ API(money) Idempotency-Key ë¯¸ì‚¬ìš©                      â”‚
â”‚     â†’ money ì„œë¹„ìŠ¤ ìŠ¤í™ ë³€ê²½ì— ì˜í–¥ë°›ì§€ ì•ŠìŒ                        â”‚
â”‚     â†’ ë‚´ë¶€ ì‹œìŠ¤í…œì—ì„œ ì™„ê²°ëœ ë©±ë“±ì„± ë³´ì¥                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DB Unique Constraint ì„¤ê³„

```sql
CREATE TABLE payment_result (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    status          VARCHAR(20) NOT NULL,
    money_tx_id     VARCHAR(100),
    error_message   VARCHAR(500),
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ë©±ë“±ì„± ë³´ì¥
    UNIQUE KEY uk_idempotency (campaign_id, member_id)
);
```

### ì²˜ë¦¬ ë¡œì§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¥ Consumer ì²˜ë¦¬ íë¦„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ ë©”ì‹œì§€ ìˆ˜ì‹     â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    No    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ ìº í˜ì¸ ìƒíƒœ ì²´í¬    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Skip     â”‚                  â”‚
â”‚  â”‚ (ìºì‹œ í™œìš©)       â”‚          â”‚ ë©”ì‹œì§€íê¸°  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚           â”‚ Yes                                             â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ DB INSERT ì‹œë„            â”‚                               â”‚
â”‚  â”‚ payment_result í…Œì´ë¸”      â”‚                               â”‚
â”‚  â”‚ (campaign_id, member_id) â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                           â”‚
â”‚     â–¼           â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ ì„±ê³µ  â”‚   â”‚ DuplicateKey   â”‚                              â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜   â”‚ Exception      â”‚                              â”‚
â”‚     â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚     â”‚               â–¼                                       â”‚
â”‚     â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚     â”‚       â”‚ âœ… Skip      â”‚                                â”‚
â”‚     â”‚       â”‚ (ì´ë¯¸ ì²˜ë¦¬ë¨)   â”‚                                â”‚
â”‚     â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ money API í˜¸ì¶œ   â”‚                                        â”‚
â”‚  â”‚ í¬ì¸íŠ¸ ì§€ê¸‰ ìš”ì²­    â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                           â”‚
â”‚     â–¼           â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ ì„±ê³µ  â”‚   â”‚ ì‹¤íŒ¨          â”‚                                â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚     â”‚              â–¼                                        â”‚
â”‚     â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚     â”‚       â”‚ DLT ë°œí–‰      â”‚                                â”‚
â”‚     â”‚       â”‚ + Redis ì‹¤íŒ¨  â”‚                                â”‚
â”‚     â”‚       â”‚   ì¹´ìš´íŠ¸ ++   â”‚                                â”‚
â”‚     â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ ê²°ê³¼ ì—…ë°ì´íŠ¸          â”‚                                    â”‚
â”‚  â”‚ status = SUCCESS    â”‚                                    â”‚
â”‚  â”‚ + Redis ì„±ê³µ ì¹´ìš´íŠ¸ ++ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ë°ì´í„° ëª¨ë¸

### ERD

```mermaid
erDiagram
    CAMPAIGN_PAYMENT_SUMMARY ||--o{ PAYMENT_TARGET : contains
    CAMPAIGN_PAYMENT_SUMMARY ||--o{ PAYMENT_RESULT : produces
    PAYMENT_TARGET ||--o| PAYMENT_RESULT : generates
    
    CAMPAIGN_PAYMENT_SUMMARY {
        bigint id PK
        varchar campaign_id UK "ì›ì²œ ìº í˜ì¸ ì°¸ì¡°"
        varchar status
        int total_count
        int success_count
        int fail_count
        timestamp started_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    PAYMENT_TARGET {
        bigint id PK
        varchar campaign_id FK
        varchar member_id
        bigint amount
        varchar reason
        int partition_key
        varchar publish_status
        varchar pay_status
        int retry_count
        timestamp created_at
        timestamp updated_at
    }
    
    PAYMENT_RESULT {
        bigint id PK
        varchar campaign_id FK
        varchar member_id UK
        bigint amount
        varchar status
        varchar money_tx_id
        varchar error_message
        timestamp created_at
        timestamp updated_at
    }
```

### í…Œì´ë¸” DDL

```sql
-- ìº í˜ì¸ ì§€ê¸‰ í˜„í™© í…Œì´ë¸”
CREATE TABLE campaign_payment_summary (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL UNIQUE,  -- ì›ì²œ ìº í˜ì¸ ì°¸ì¡° í‚¤
    status          VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    total_count     INT DEFAULT 0,
    success_count   INT DEFAULT 0,
    fail_count      INT DEFAULT 0,
    started_at      TIMESTAMP NULL,
    completed_at    TIMESTAMP NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_status (status),
    INDEX idx_created (created_at)
) COMMENT 'ìº í˜ì¸ ì§€ê¸‰ í˜„í™©';

-- ì§€ê¸‰ ëŒ€ìƒ í…Œì´ë¸”
CREATE TABLE payment_target (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    reason          VARCHAR(500),
    partition_key   INT NOT NULL,
    publish_status  VARCHAR(20) DEFAULT 'PENDING',
    pay_status      VARCHAR(20) DEFAULT 'PENDING',
    retry_count     INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_partition_publish (campaign_id, partition_key, publish_status),
    INDEX idx_pay_status (campaign_id, pay_status),
    INDEX idx_retry (campaign_id, pay_status, retry_count)
);

-- ì§€ê¸‰ ê²°ê³¼ í…Œì´ë¸”
CREATE TABLE payment_result (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    status          VARCHAR(20) NOT NULL,
    money_tx_id     VARCHAR(100),
    error_message   VARCHAR(500),
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_idempotency (campaign_id, member_id),
    INDEX idx_status (campaign_id, status)
);
```

### ìƒíƒœ ì •ì˜

#### Campaign Payment Status (ìº í˜ì¸ ì§€ê¸‰ ìƒíƒœ)

| ìƒíƒœ | ì„¤ëª… |
|:----:|------|
| `PENDING` | ìº í˜ì¸ ìƒì„±ë¨, ì§€ê¸‰ ëŒ€ê¸° |
| `RUNNING` | ì§€ê¸‰ ì§„í–‰ ì¤‘ |
| `COMPLETED` | ì§€ê¸‰ ì™„ë£Œ (ë¶€ë¶„ ì‹¤íŒ¨ í¬í•¨) |
| `FAILED` | ì‹œìŠ¤í…œ ì¥ì• ë¡œ ì‹¤íŒ¨ |
| `STOPPED` | ìˆ˜ë™ ì¤‘ë‹¨ |

#### Payment Status

| ìƒíƒœ | ì„¤ëª… |
|:----:|------|
| `PENDING` | ì§€ê¸‰ ëŒ€ê¸° |
| `PUBLISHED` | Kafka ë°œí–‰ ì™„ë£Œ |
| `PROCESSING` | ì§€ê¸‰ ì²˜ë¦¬ ì¤‘ |
| `SUCCESS` | ì§€ê¸‰ ì„±ê³µ |
| `FAILED` | ì§€ê¸‰ ì‹¤íŒ¨ (DLT ì¬ì²˜ë¦¬ ëŒ€ìƒ) |
| `PERMANENTLY_FAILED` | ì¬ì²˜ë¦¬ í•œë„ ì´ˆê³¼ (ìµœì¢… ì‹¤íŒ¨) |

---

## ğŸ“ˆ ì˜ˆìƒ ì„±ëŠ¥

### Publisher vs Consumer ì—­í•  êµ¬ë¶„

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  | ë³‘ëª© ì—¬ë¶€ |
|----------|------|:--------:|
| **Publisher** | DB ì¡°íšŒ â†’ Kafka ë°œí–‰ | âŒ ë¹ ë¦„ |
| **Consumer** | Kafka ì†Œë¹„ â†’ money API í˜¸ì¶œ | âœ… **ë³‘ëª©** |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ ì²˜ë¦¬ ì†ë„ ë¹„êµ                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Publisher: DB ì¡°íšŒ + Kafka ë°œí–‰ â†’ 10,000+ msg/s ê°€ëŠ¥        â”‚
â”‚  Consumer: money API í˜¸ì¶œ â†’ 1,000 TPS ì œí•œ (ë³‘ëª©)            â”‚
â”‚                                                              â”‚
â”‚  â†’ Kafkaê°€ ì†ë„ ì°¨ì´ë¥¼ ë²„í¼ë§!                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì²˜ë¦¬ ì‹œê°„ ì‚°ì •

| í•­ëª© | ê°’ | ì„¤ëª… |
|------|---|------|
| ì „ì²´ ëŒ€ìƒ | 1,000,000 ê±´ | |
| Kafka íŒŒí‹°ì…˜ ìˆ˜ | 4ê°œ | |
| Consumer ìˆ˜ | 4ê°œ | íŒŒí‹°ì…˜ë‹¹ 1ê°œ |
| money API TPS | 1,000 | ì „ì²´ Consumer í•©ì‚° |
| Consumerë‹¹ TPS | 250 | 1000 / 4 |
| ì²˜ë¦¬ ì‹œê°„ | 1,000,000 / 1,000 = **1,000ì´ˆ (ì•½ 17ë¶„)** | |

> [!success] ì˜ˆìƒ ê²°ê³¼
> 100ë§Œ ê±´ ì²˜ë¦¬ ì‹œê°„: **ì•½ 20ë¶„** (ì˜¤ë²„í—¤ë“œ í¬í•¨)
> - ìš”êµ¬ ì‚¬í•­(1~4ì‹œê°„) ëŒ€ë¹„ ì¶©ë¶„í•œ ì—¬ìœ 

### í™•ì¥ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š Consumer ìˆ˜ì— ë”°ë¥¸ ì²˜ë¦¬ ì‹œê°„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Consumer 4ê°œ  (íŒŒí‹°ì…˜ 4ê°œ) : ì•½ 20ë¶„                           â”‚
â”‚  Consumer 8ê°œ  (íŒŒí‹°ì…˜ 8ê°œ) : ì•½ 10ë¶„                           â”‚
â”‚  Consumer 16ê°œ (íŒŒí‹°ì…˜ 16ê°œ): ì•½ 5ë¶„                            â”‚
â”‚                                                             â”‚
â”‚  â€» Consumer ìˆ˜ â‰¤ Kafka íŒŒí‹°ì…˜ ìˆ˜ (ì¤‘ìš”!)                        â”‚
â”‚  â€» money API TPS ì œí•œ(1000)ì´ ìµœì¢… bottleneck                  â”‚
â”‚  â€» money API TPS ì¦ê°€ ì‹œ Consumer í™•ì¥ìœ¼ë¡œ ì„ í˜• ì„±ëŠ¥ í–¥ìƒ          |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Consumer ìŠ¤ì¼€ì¼ë§ ì£¼ì˜ì‚¬í•­

> [!warning] Consumer ìˆ˜ â‰¤ Kafka íŒŒí‹°ì…˜ ìˆ˜
> - íŒŒí‹°ì…˜ 4ê°œ â†’ Consumer ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ë³‘ë ¬ ì²˜ë¦¬
> - Consumer 5ê°œ ì´ìƒ ë°°í¬í•´ë„ 1ê°œëŠ” ìœ íœ´ ìƒíƒœ
> - ë” ë§ì€ ë³‘ë ¬ ì²˜ë¦¬ í•„ìš” ì‹œ **íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€ í•„ìš”**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ íŒŒí‹°ì…˜ < Consumer ì¸ ê²½ìš°                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Kafka íŒŒí‹°ì…˜: 4ê°œ                                           â”‚
â”‚  Consumer: 6ê°œ                                               â”‚
â”‚                                                              â”‚
â”‚  â†’ Consumer 0~3: ê° íŒŒí‹°ì…˜ ë‹´ë‹¹ (í™œì„±)                       â”‚
â”‚  â†’ Consumer 4~5: ë‹´ë‹¹ íŒŒí‹°ì…˜ ì—†ìŒ (ìœ íœ´)                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Bottleneck ë¶„ì„

| êµ¬ê°„ | ì˜ˆìƒ TPS | Bottleneck ì—¬ë¶€ |
|------|---------|:---------------:|
| DB ì¡°íšŒ (íŒŒí‹°ì…˜ë³„) | 10,000+ | âŒ |
| Kafka ë°œí–‰ | 50,000+ | âŒ |
| Kafka ì†Œë¹„ | 50,000+ | âŒ |
| **money API** | **1,000** | **âœ…** |
| DB ì—…ë°ì´íŠ¸ | 5,000+ | âŒ |

---

## ğŸ”„ ì¬ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ (DLT ê¸°ë°˜)

### ê°œìš”

> [!note] DLT(Dead Letter Topic) íŒ¨í„´
> ì²˜ë¦¬ ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë¥¼ ë³„ë„ í† í”½ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì²˜ë¦¬í•˜ëŠ” Kafka íŒ¨í„´ì…ë‹ˆë‹¤.
> Fat Messageë¥¼ í™œìš©í•˜ì—¬ DB ì¬ì¡°íšŒ ì—†ì´ ë©”ì‹œì§€ë§Œìœ¼ë¡œ ì¬ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### í† í”½ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¨ í† í”½ êµ¬ì¡°                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  payment-request          ì •ìƒ ì²˜ë¦¬ í† í”½                       â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”‚ ì‹¤íŒ¨ ì‹œ                                               â”‚
â”‚       â–¼                                                     â”‚
â”‚  payment-request.DLT      ì¬ì²˜ë¦¬ ëŒ€ìƒ í† í”½                      â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”‚ ì¬ì‹œë„ í•œë„ ì´ˆê³¼ ì‹œ                                      â”‚
â”‚       â–¼                                                     â”‚
â”‚  payment-request.DLT.FINAL  ìµœì¢… ì‹¤íŒ¨ í† í”½ (ìˆ˜ë™ í™•ì¸)            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| í† í”½ | ì—­í•  | Consumer |
|------|------|----------|
| `payment-request` | ì •ìƒ ì²˜ë¦¬ | PaymentConsumer |
| `payment-request.DLT` | ì¬ì²˜ë¦¬ ëŒ€ìƒ | RetryConsumer |
| `payment-request.DLT.FINAL` | ìµœì¢… ì‹¤íŒ¨ (ìˆ˜ë™ í™•ì¸) | - (ëª¨ë‹ˆí„°ë§) |

### ì¬ì²˜ë¦¬ ì•„í‚¤í…ì²˜

```mermaid
flowchart TB
    subgraph Normal["ì •ìƒ íë¦„"]
        A[payment-request] --> B[PaymentConsumer]
        B --> C[money API í˜¸ì¶œ]
        C --> D{ì„±ê³µ?}
        D -->|Yes| E[DB ìƒíƒœ ì—…ë°ì´íŠ¸<br/>SUCCESS]
    end
    
    subgraph DLT["DLT ì¬ì²˜ë¦¬ íë¦„"]
        D -->|No| F[DLT ë°œí–‰]
        F --> G[payment-request.DLT]
        G --> H[RetryConsumer]
        H --> I[ì§€ì—° í›„ ì¬ì‹œë„]
        I --> J[money API í˜¸ì¶œ]
        J --> K{ì„±ê³µ?}
        K -->|Yes| L[DB ìƒíƒœ ì—…ë°ì´íŠ¸<br/>SUCCESS]
        K -->|No| M{retry < 5?}
        M -->|Yes| F
        M -->|No| N[Final DLT ë°œí–‰]
    end
    
    subgraph Final["ìµœì¢… ì‹¤íŒ¨"]
        N --> O[payment-request.DLT.FINAL]
        O --> P[ìˆ˜ë™ í™•ì¸ í•„ìš”]
        P --> Q[ì•Œë¦¼ ë°œì†¡]
    end
```

### ë©”ì‹œì§€ êµ¬ì¡° (ì¬ì²˜ë¦¬ í•„ë“œ ì¶”ê°€)

```json
{
  "messageId": "550e8400-e29b-41d4-a716-446655440000",
  "targetId": 12345,
  "campaignId": "C001",
  "memberId": "M12345",
  "amount": 1000,
  "reason": "ì‹ ë…„ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ ì§€ê¸‰",
  "publishedAt": "2026-01-15T10:30:00Z",
  "retryCount": 0,
  "errorMessage": null,
  "lastFailedAt": null
}
```

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `retryCount` | Integer | ì¬ì‹œë„ íšŸìˆ˜ |
| `errorMessage` | String | ë§ˆì§€ë§‰ ì‹¤íŒ¨ ì›ì¸ |
| `lastFailedAt` | ISO8601 | ë§ˆì§€ë§‰ ì‹¤íŒ¨ ì‹œê° |

### Consumer ì²˜ë¦¬ ë¡œì§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¥ PaymentConsumer ì²˜ë¦¬ ë¡œì§                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ë©”ì‹œì§€ ìˆ˜ì‹  (payment-request)                              â”‚
â”‚  2. ìº í˜ì¸ ìƒíƒœ ì²´í¬                                            â”‚
â”‚  3. DB INSERT (ë©±ë“±ì„± ì²´í¬)                                    â”‚
â”‚  4. money API í˜¸ì¶œ                                           â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€ ì„±ê³µ â†’ DB UPDATE (SUCCESS)                            â”‚
â”‚     â”‚         Redis ì„±ê³µ ì¹´ìš´íŠ¸ ++                             â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€ ì‹¤íŒ¨ â†’ retryCount++                                   â”‚
â”‚              errorMessage ì„¤ì •                               â”‚
â”‚              payment-request.DLT ë¡œ ë°œí–‰                      â”‚
â”‚              Redis ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ++                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ RetryConsumer ì²˜ë¦¬ ë¡œì§                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ë©”ì‹œì§€ ìˆ˜ì‹  (payment-request.DLT)                          â”‚
â”‚  2. ì§€ì—° ì‹œê°„ ê³„ì‚° (Exponential Backoff)                        â”‚
â”‚     - 1íšŒì°¨: 1ë¶„                                              â”‚
â”‚     - 2íšŒì°¨: 2ë¶„                                              â”‚
â”‚     - 3íšŒì°¨: 4ë¶„                                              â”‚
â”‚     - 4íšŒì°¨: 8ë¶„                                              â”‚
â”‚  3. ì§€ì—° í›„ money API ì¬í˜¸ì¶œ                                    â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€ ì„±ê³µ â†’ DB UPDATE (SUCCESS)                            â”‚
â”‚     â”‚         Redis ì„±ê³µ ì¹´ìš´íŠ¸ ++                             â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€ ì‹¤íŒ¨ â†’ retryCount ì²´í¬                                 â”‚
â”‚              â”‚                                              â”‚
â”‚              â”œâ”€ < 5íšŒ â†’ payment-request.DLT ì¬ë°œí–‰            â”‚
â”‚              â”‚                                              â”‚
â”‚              â””â”€ â‰¥ 5íšŒ â†’ payment-request.DLT.FINAL ë°œí–‰        â”‚
â”‚                         DB UPDATE (PERMANENTLY_FAILED)      â”‚
â”‚                         ì•Œë¦¼ ë°œì†¡                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìƒíƒœ ì •ì˜ (í™•ì¥)

|          ìƒíƒœ          | ì„¤ëª…                              |
| :------------------: | ------------------------------- |
|       `FAILED`       | ì§€ê¸‰ ì‹¤íŒ¨ (DLTì—ì„œ ì¬ì²˜ë¦¬ ì¤‘)             |
| `PERMANENTLY_FAILED` | ì¬ì²˜ë¦¬ í•œë„ ì´ˆê³¼ (ìµœì¢… ì‹¤íŒ¨, ìˆ˜ë™ í™•ì¸ í•„ìš”)    |

> [!note] ìƒíƒœ ì „ì´ íë¦„
> - **ì²« ì‹¤íŒ¨**: `PENDING` â†’ `FAILED` + DLT ë°œí–‰
> - **ì¬ì‹œë„ ì„±ê³µ**: `FAILED` â†’ `SUCCESS`
> - **ì¬ì‹œë„ í•œë„ ì´ˆê³¼**: `FAILED` â†’ `PERMANENTLY_FAILED` + Final DLT ë°œí–‰

### DLT ë°©ì‹ì˜ ì¥ì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… DLT ë°©ì‹ ì¥ì                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. DB ë¶€í•˜ ê°ì†Œ                                              â”‚
â”‚     - ì£¼ê¸°ì  FAILED ê±´ ì¡°íšŒ ë¶ˆí•„ìš”                               â”‚
â”‚     - ë©”ì‹œì§€ë§Œìœ¼ë¡œ ì¬ì²˜ë¦¬ ê°€ëŠ¥ (Fat Message)                      â”‚
â”‚                                                             â”‚
â”‚  2. ì‹¤ì‹œê°„ ì¬ì²˜ë¦¬                                              â”‚
â”‚     - ì‹¤íŒ¨ ì¦‰ì‹œ DLT ëŒ€ê¸°ì—´ë¡œ ì´ë™                                â”‚
â”‚     - ë°°ì¹˜ ì£¼ê¸° ëŒ€ê¸° ì—†ìŒ                                       â”‚
â”‚                                                             â”‚
â”‚  3. ê²©ë¦¬ëœ ì²˜ë¦¬                                                â”‚
â”‚     - ì¬ì²˜ë¦¬ ë¡œì§ì´ ì •ìƒ íë¦„ì— ì˜í–¥ ì—†ìŒ                           â”‚
â”‚     - ë³„ë„ Consumer ê·¸ë£¹ìœ¼ë¡œ ë…ë¦½ ìš´ì˜                           â”‚
â”‚                                                             â”‚
â”‚  4. ëª¨ë‹ˆí„°ë§ ìš©ì´                                              â”‚
â”‚     - DLT í† í”½ lag ëª¨ë‹ˆí„°ë§                                    â”‚
â”‚     - Final DLT ë©”ì‹œì§€ ìˆ˜ ì•Œë¦¼                                 â”‚
â”‚                                                             â”‚
â”‚  5. Kafka ìƒíƒœê³„ í™œìš©                                          â”‚
â”‚     - ë©”ì‹œì§€ ë³´ì¡´ (retention)                                  â”‚
â”‚     - Replay ê°€ëŠ¥                                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸

| ë©”íŠ¸ë¦­ | ì„¤ëª… | ì•Œë¦¼ ê¸°ì¤€ |
|--------|------|----------|
| `payment-request.DLT` lag | ì¬ì²˜ë¦¬ ëŒ€ê¸° ê±´ìˆ˜ | > 1000ê±´ |
| `payment-request.DLT.FINAL` ë©”ì‹œì§€ ìˆ˜ | ìµœì¢… ì‹¤íŒ¨ ê±´ìˆ˜ | > 0ê±´ (ì¦‰ì‹œ ì•Œë¦¼) |
| RetryConsumer ì²˜ë¦¬ ì‹œê°„ | ì¬ì²˜ë¦¬ í‰ê·  ì†Œìš” ì‹œê°„ | > 5ë¶„ |

---

## âš ï¸ ì¥ì•  ëŒ€ì‘

### ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ ë° ëŒ€ì‘

| ì¥ì•  ìƒí™© | ì˜í–¥ | ëŒ€ì‘ |
|----------|------|------|
| **Publisher ì¥ì• ** | ë°œí–‰ ì¤‘ë‹¨ | ì¬ì‹œì‘ ì‹œ PENDING ê±´ë¶€í„° ì¬ë°œí–‰ â†’ Consumer ë©±ë“±ì„± ì²˜ë¦¬ |
| **Consumer ì¥ì• ** | ì²˜ë¦¬ ì¤‘ë‹¨ | Kafka Consumer Group ë¦¬ë°¸ëŸ°ì‹±, ë©”ì‹œì§€ ì¬ì²˜ë¦¬ |
| **Kafka ì¥ì• ** | ë©”ì‹œì§€ ì†ì‹¤ ê°€ëŠ¥ | Kafka í´ëŸ¬ìŠ¤í„° ë³µêµ¬, PUBLISHED ìƒíƒœ ê±´ ì¬ë°œí–‰ |
| **money API ì¥ì• ** | ì§€ê¸‰ ì‹¤íŒ¨ | DLT ê¸°ë°˜ ì¬ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ |
| **DB ì¥ì• ** | ì „ì²´ ì¤‘ë‹¨ | DB ë³µêµ¬ í›„ ì¬ì‹œì‘, íŠ¸ëœì­ì…˜ ë¡¤ë°±ëœ ê±´ ì¬ì²˜ë¦¬ |

### ë³µêµ¬ í”„ë¡œì„¸ìŠ¤

```mermaid
flowchart TB
    A[ì¥ì•  ê°ì§€] --> B{ì¥ì•  ìœ í˜•?}
    
    B -->|Publisher| C[Publisher ì¬ì‹œì‘]
    C --> D[PENDING ê±´ ì¬ë°œí–‰]
    
    B -->|Consumer| E[Consumer ì¬ì‹œì‘]
    E --> F[Kafka ë¦¬ë°¸ëŸ°ì‹±]
    F --> G[ë¯¸ì²˜ë¦¬ ë©”ì‹œì§€ ì¬ì†Œë¹„]
    
    B -->|money API| H[DLT ì¬ì²˜ë¦¬]
    H --> I{ì¬ì‹œë„ ì„±ê³µ?}
    I -->|Yes| J[ì •ìƒ ì²˜ë¦¬]
    I -->|No| K[Final DLT ì´ë™]
    K --> L[ìˆ˜ë™ í™•ì¸ í•„ìš”]
    
    B -->|DB| M[DB ë³µêµ¬ ëŒ€ê¸°]
    M --> N[ì‹œìŠ¤í…œ ì¬ì‹œì‘]
```

---

## ğŸ“ ë¶€ë¡: Kafka ì‚¬ìš© ì´ìœ 

> [!question] ì™œ Kafkaê°€ í•„ìš”í•œê°€?
> DB íŒŒí‹°ì…”ë‹ë§Œìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•œë°, ì™œ Publisher â†’ Kafka â†’ Consumer êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

### í•µì‹¬ ì´ìœ 

| ì´ìœ  | ì„¤ëª… |
|------|------|
| **ë¹„ë™ê¸° ì²˜ë¦¬** | PublisherëŠ” API ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ê³„ì† ë°œí–‰ ê°€ëŠ¥ |
| **ë²„í¼ë§** | money API TPS ì œí•œ(1000)ì— ë§ì¶° Consumerê°€ ì¡°ì ˆ |
| **ì¥ì•  ê²©ë¦¬** | money API ì¥ì•  ì‹œì—ë„ ë©”ì‹œì§€ëŠ” Kafkaì— ì•ˆì „í•˜ê²Œ ë³´ê´€ |
| **ì¬ì²˜ë¦¬** | Consumer offset ë¦¬ì…‹ìœ¼ë¡œ ê³¼ê±° ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ê°€ëŠ¥ |
| **ë…ë¦½ í™•ì¥** | Publisher/Consumerë¥¼ ë…ë¦½ì ìœ¼ë¡œ ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥ |

### ìƒì„¸ ë¶„ì„

#### 1. ë¹„ë™ê¸° ì²˜ë¦¬ & ë””ì»¤í”Œë§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”— Kafka ì—†ì´ (ë™ê¸°)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Worker â†’ DB ì¡°íšŒ â†’ money API (ëŒ€ê¸°) â†’ ë‹¤ìŒ ê±´ ì²˜ë¦¬          â”‚
â”‚  â†’ money API ì‘ë‹µ ëŒ€ê¸° ì¤‘ Workerê°€ ë¸”ë¡œí‚¹ë¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”— Kafka ì‚¬ìš© (ë¹„ë™ê¸°)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Publisher â†’ DB ì¡°íšŒ â†’ Kafka ë°œí–‰ (ì¦‰ì‹œ) â†’ ë‹¤ìŒ ê±´           â”‚
â”‚  Consumer â†’ Kafka ì†Œë¹„ â†’ money API í˜¸ì¶œ                      â”‚
â”‚  â†’ PublisherëŠ” API ì‘ë‹µê³¼ ë¬´ê´€í•˜ê²Œ ë¹ ë¥´ê²Œ ë°œí–‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. ë²„í¼ë§ & ë°±í”„ë ˆì…”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ Kafka = ë²„í¼ ì—­í•                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Publisher: 10,000 msg/s ë°œí–‰ ê°€ëŠ¥                           â”‚
â”‚                    â†“                                         â”‚
â”‚  [Kafka: ë©”ì‹œì§€ ë²„í¼ë§] â† 100ë§Œ ê±´ ë³´ê´€ ê°€ëŠ¥                 â”‚
â”‚                    â†“                                         â”‚
â”‚  Consumer: 1,000 msg/s ì²˜ë¦¬ (money API ì œí•œ)                 â”‚
â”‚                                                              â”‚
â”‚  â†’ ì†ë„ ì°¨ì´ë¥¼ Kafkaê°€ í¡ìˆ˜!                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. ì¥ì•  ê²©ë¦¬ & ë©”ì‹œì§€ ë³´ì¡´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ ì‹œë‚˜ë¦¬ì˜¤: money API 30ë¶„ ì¥ì•                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Kafka ì—†ì´]                                                â”‚
â”‚  Worker â†’ money API í˜¸ì¶œ ì‹¤íŒ¨ â†’ ì¬ì‹œë„ ë°˜ë³µ â†’ Worker ë©ˆì¶¤    â”‚
â”‚                                                              â”‚
â”‚  [Kafka ì‚¬ìš©]                                                â”‚
â”‚  Publisher â†’ Kafka ë°œí–‰ (ì •ìƒ ì§„í–‰!)                         â”‚
â”‚  Consumer â†’ money API í˜¸ì¶œ ì‹¤íŒ¨ â†’ ì¬ì‹œë„/ëŒ€ê¸°                â”‚
â”‚  â†’ ë©”ì‹œì§€ëŠ” Kafkaì— ì•ˆì „í•˜ê²Œ ë³´ê´€                            â”‚
â”‚  â†’ ì¥ì•  ë³µêµ¬ í›„ Consumerê°€ ì´ì–´ì„œ ì²˜ë¦¬                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. Kafka ì—†ì´ ì§ì ‘ êµ¬í˜„ ì‹œ í•„ìš”í•œ ê²ƒë“¤

| Kafkaê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ | ì§ì ‘ êµ¬í˜„ ì‹œ |
|---------------------|------------|
| ë©”ì‹œì§€ ë²„í¼ë§ | In-memory Queue ë˜ëŠ” DB Queue |
| ì¥ì•  ì‹œ ë©”ì‹œì§€ ë³´ì¡´ | DB ìƒíƒœ ê´€ë¦¬ë¡œ ëŒ€ì²´ |
| Consumer í™•ì¥ | Worker í™•ì¥ + íŒŒí‹°ì…˜ ê´€ë¦¬ |
| ì¬ì²˜ë¦¬ (Replay) | DB ìƒíƒœ ê¸°ë°˜ ì¬ì¡°íšŒ |
| Rate Limiting | ìì²´ êµ¬í˜„ (Resilience4j ë“±) |

---

## ğŸ“ ë¶€ë¡: partition_key ìƒì„± ì „ëµ

### ë°°ê²½

Publisherê°€ íŒŒí‹°ì…˜ë³„ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë ¤ë©´ `partition_key` ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤. 
ì´ ì»¬ëŸ¼ì„ ì–´ë–»ê²Œ ìƒì„±í• ì§€ì— ëŒ€í•œ ì „ëµì…ë‹ˆë‹¤.

### ë°©ì‹ ë¹„êµ

| êµ¬ë¶„ | ë°©ì‹ | ì ì¬ ë¹„ìš© | ì¡°íšŒ ì„±ëŠ¥ | ê¶Œì¥ë„ |
|------|------|:--------:|:--------:|:------:|
| Option A | ë³„ë„ UPDATE | âŒ ë†’ìŒ | âœ… ë¹ ë¦„ | â­â­â­ |
| Option B | ì¡°íšŒ ì‹œ í•´ì‹œ ê³„ì‚° | âœ… ì—†ìŒ | âŒ ëŠë¦¼ (Full Scan) | â­ |
| **Option C** | **INSERT ì‹œ ê³„ì‚°** | âœ… ë‚®ìŒ | âœ… ë¹ ë¦„ | â­â­â­â­â­ |
| **Option D** | **Generated Column** | âœ… ì—†ìŒ | âœ… ë¹ ë¦„ | â­â­â­â­â­ |

> [!warning] ì¡°íšŒ ì‹œ í•´ì‹œ ê³„ì‚°ì˜ ë¬¸ì œ
> `WHERE MOD(ABS(CRC32(...)), 4) = 0` ì¡°ê±´ì€ **ì¸ë±ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ì—†ì–´** Full Table Scan ë°œìƒ

---

### Option C: INSERT ì‹œ partition_key í•¨ê»˜ ì €ì¥ (ê¶Œì¥)

ë°ì´í„° ì ì¬ ì‹œ partition_keyë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê³„ì‚°í•˜ì—¬ í•¨ê»˜ ì €ì¥í•©ë‹ˆë‹¤.

#### í…Œì´ë¸” ì •ì˜

```sql
CREATE TABLE payment_target (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    reason          VARCHAR(500),
    partition_key   INT NOT NULL,  -- ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê³„ì‚°í•˜ì—¬ ì €ì¥
    publish_status  VARCHAR(20) DEFAULT 'PENDING',
    pay_status      VARCHAR(20) DEFAULT 'PENDING',
    retry_count     INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_partition_publish (campaign_id, partition_key, publish_status)
);
```

#### INSERT ì½”ë“œ (Java)

```java
public void savePaymentTarget(PaymentTarget target, int partitionCount) {
    // partition_key ê³„ì‚°
    String hashSource = target.getCampaignId() + target.getMemberId();
    int partitionKey = Math.abs(hashSource.hashCode()) % partitionCount;
    target.setPartitionKey(partitionKey);
    
    paymentTargetRepository.save(target);
}
```

#### INSERT SQL

```sql
INSERT INTO payment_target (campaign_id, member_id, amount, reason, partition_key)
VALUES (
    :campaignId, 
    :memberId, 
    :amount, 
    :reason,
    MOD(ABS(CRC32(CONCAT(:campaignId, :memberId))), 4)
);
```

#### ì¥ì 

- ë³„ë„ UPDATE ë¶ˆí•„ìš”
- ì¸ë±ìŠ¤ í™œìš© ê°€ëŠ¥
- ë°ì´í„° ì ì¬ ê³¼ì •ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬
- íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì‹œ ìœ ì—°í•˜ê²Œ ëŒ€ì‘ ê°€ëŠ¥

---

### Option D: Generated Column ì‚¬ìš©

MySQL 5.7+, PostgreSQLì—ì„œ ì§€ì›í•˜ëŠ” ê³„ì‚°ëœ ì»¬ëŸ¼ì„ í™œìš©í•©ë‹ˆë‹¤.

#### í…Œì´ë¸” ì •ì˜ (MySQL)

```sql
CREATE TABLE payment_target (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    reason          VARCHAR(500),
    
    -- Generated Column: INSERT ì‹œ ìë™ ê³„ì‚°ë¨
    partition_key   INT GENERATED ALWAYS AS (
        MOD(ABS(CRC32(CONCAT(campaign_id, member_id))), 4)
    ) STORED,
    
    publish_status  VARCHAR(20) DEFAULT 'PENDING',
    pay_status      VARCHAR(20) DEFAULT 'PENDING',
    retry_count     INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_partition_publish (campaign_id, partition_key, publish_status)
);
```

#### í…Œì´ë¸” ì •ì˜ (PostgreSQL)

```sql
CREATE TABLE payment_target (
    id              BIGSERIAL PRIMARY KEY,
    campaign_id     VARCHAR(50) NOT NULL,
    member_id       VARCHAR(50) NOT NULL,
    amount          BIGINT NOT NULL,
    reason          VARCHAR(500),
    
    -- Generated Column
    partition_key   INT GENERATED ALWAYS AS (
        MOD(ABS(HASHTEXT(campaign_id || member_id)), 4)
    ) STORED,
    
    publish_status  VARCHAR(20) DEFAULT 'PENDING',
    pay_status      VARCHAR(20) DEFAULT 'PENDING',
    retry_count     INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_partition_publish ON payment_target (campaign_id, partition_key, publish_status);
```

#### INSERT (partition_key ëª…ì‹œ ë¶ˆí•„ìš”)

```sql
-- partition_keyëŠ” ìë™ ê³„ì‚°ë˜ë¯€ë¡œ ëª…ì‹œí•˜ì§€ ì•ŠìŒ
INSERT INTO payment_target (campaign_id, member_id, amount, reason)
VALUES (:campaignId, :memberId, :amount, :reason);
```

#### ì¥ì 

- ë°ì´í„° INSERT ì‹œ **ìë™ ê³„ì‚°**
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œ partition_key ê³„ì‚° ë¡œì§ ë¶ˆí•„ìš”
- ì¸ë±ìŠ¤ ìƒì„± ê°€ëŠ¥ (`STORED` ì˜µì…˜)
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ (DB ë ˆë²¨ì—ì„œ ê°•ì œ)

#### ì£¼ì˜ì‚¬í•­

| í•­ëª© | ì„¤ëª… |
|------|------|
| `VIRTUAL` vs `STORED` | ì¸ë±ìŠ¤ì—ëŠ” `STORED` í•„ìˆ˜ |
| íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ | ì»¬ëŸ¼ ì •ì˜ ë³€ê²½ í•„ìš” (DDL) |
| DB ë²„ì „ | MySQL 5.7+, PostgreSQL 11+ |

---

### ìµœì¢… ì„ íƒ: Option C (INSERT ì‹œ ê³„ì‚°)

> [!success] ì„ íƒ ì´ìœ 
> - íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì‹œ DDL ë³€ê²½ ì—†ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ë§Œ ìˆ˜ì •
> - ìº í˜ì¸ë³„ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ìˆ˜ ì ìš© ê°€ëŠ¥ (ìœ ì—°ì„±)
> - ë¬´ì¤‘ë‹¨ ë³€ê²½ ê°€ëŠ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Option C vs Option D ì„ íƒ ê¸°ì¤€                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [Option C ì„ íƒ (ë³¸ ì‹œìŠ¤í…œ)]                                 â”‚
â”‚  â†’ íŒŒí‹°ì…˜ ìˆ˜ ë™ì  ë³€ê²½ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²½ìš°                    â”‚
â”‚  â†’ ìº í˜ì¸ë³„ ë‹¤ë¥¸ íŒŒí‹°ì…˜ ìˆ˜ ì ìš©ì´ í•„ìš”í•œ ê²½ìš°                â”‚
â”‚  â†’ DDL ë³€ê²½ ì—†ì´ ìš´ì˜í•˜ê³  ì‹¶ì€ ê²½ìš°                          â”‚
â”‚                                                              â”‚
â”‚  [Option D ì„ íƒ]                                             â”‚
â”‚  â†’ íŒŒí‹°ì…˜ ìˆ˜ê°€ ê³ ì •ë˜ì–´ ë³€ê²½ ê°€ëŠ¥ì„±ì´ ë‚®ì€ ê²½ìš°              â”‚
â”‚  â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë‹¨ìˆœí™”ê°€ ë” ì¤‘ìš”í•œ ê²½ìš°                 â”‚
â”‚  â†’ DB ë ˆë²¨ ë°ì´í„° ë¬´ê²°ì„± ê°•ì œê°€ í•„ìš”í•œ ê²½ìš°                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ë‹¤ìŒ ë‹¨ê³„

- [x] High-Level Architecture ì„¤ê³„
- [x] ì²˜ë¦¬ íë¦„ ì„¤ê³„
- [x] ë³‘ë ¬ ì²˜ë¦¬ ì „ëµ ìˆ˜ë¦½
- [x] ë©±ë“±ì„± ë³´ì¥ ì „ëµ ìˆ˜ë¦½
- [x] ë°ì´í„° ëª¨ë¸ ì„¤ê³„
- [x] ì˜ˆìƒ ì„±ëŠ¥ ë¶„ì„
- [x] ì¥ì•  ëŒ€ì‘ ë°©ì•ˆ
- [ ] API Spec ì •ì˜
- [ ] ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì„¤ê³„
- [x] ì¬ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì„¤ê³„
