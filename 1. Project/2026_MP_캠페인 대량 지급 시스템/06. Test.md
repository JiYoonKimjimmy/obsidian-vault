## 캠페인 프로모션 테스트 시나리오
### 로컬 테스트
- [x] 단일 프로모션 성공 테스트
- [x] 단일 프로모션 1회 실패 > 재처리 성공 테스트
- [x] 단일 프로모션 1회 실패 > 재처리 실패 > DLT 메시지 발행 테스트
- [x] 다중 프로모션 성공 테스트
### Sandbox 테스트
- [ ] 단일 프로모션 성공 테스트
- [ ] 단일 프로모션 1회 실패 > 재처리 성공 테스트
- [ ] 단일 프로모션 1회 실패 > 재처리 실패 > DLT 메시지 발행 테스트
- [ ] 다중 프로모션 성공 테스트

---

## 테스트 방법

1. 캠페인 프로모션 데이터 생성
```sql
-- 상품권 데이터 자동 생성  
CALL prepay_admin.generate_campaign_voucher_from_issued('camp-promotion-6', 1, 4);
-- 모든 테스트 데이터 삭제  
-- CALL prepay_admin.delete_campaign_by_code('camp-promotion-6');
```
2. 캠페인 프로모션 예약 일시 기준 `prepay-batch` Job 실행
```bash
--spring.batch.job.name=CampaignPromotionPublisherJob executionTime={reservation_at}
```

---

## 프로모션 대상자 정보

### 1월 27일 기준
```sql
select distinct ect.customer_uid  
from money.event_charge_target ect  
inner join money.event_target et  
on ect.member_uid = et.member_uid  
;
```

---

### Batch Run Command

```bash
./gradlew :batch:bootRun --args='--spring.batch.job.name=CampaignPromotionPublisherJob executionTime=202602042113'

./gradlew :batch:bootRun --args="--spring.batch.job.name=CampaignPromotionPublisherJob executionTime=$(date +'%Y%m%d%H%M')"
```


```sql
# ============================================================================  
# FK 제약 조건 삭제 및 UK/INDEX 변경 ALTER 문  
# 적용 대상: 개발계 DB  
# ============================================================================  
  
-- 1. campaign_promotion_summary: FK 삭제 후 UK 추가 --------------------------  
ALTER TABLE prepay_admin.campaign_promotion_summary  
    DROP FOREIGN KEY fk_campaign_promotion_summary_promotion;  
  
ALTER TABLE prepay_admin.campaign_promotion_summary  
    DROP INDEX idx_campaign_promotion_summary_promotion;  
  
ALTER TABLE prepay_admin.campaign_promotion_summary  
    ADD UNIQUE KEY uk_campaign_promotion_summary_promotion (promotion_id);  
  
  
-- 2. campaign_promotion_voucher_targets: FK 삭제 (INDEX 유지) ----------------  
  
ALTER TABLE prepay_admin.campaign_promotion_voucher_targets  
    DROP FOREIGN KEY fk_voucher_targets_promotion;  
  
  
-- 3. campaign_promotion_voucher_results: FK 삭제 후 UK 추가 ------------------  
ALTER TABLE prepay_admin.campaign_promotion_voucher_results  
    DROP FOREIGN KEY fk_voucher_results_target;  
  
ALTER TABLE prepay_admin.campaign_promotion_voucher_results  
    DROP FOREIGN KEY fk_voucher_results_promotion;  
  
ALTER TABLE prepay_admin.campaign_promotion_voucher_results  
    ADD UNIQUE KEY uk_voucher_results_target (voucher_target_id);  
  
  
-- 4. campaign_promotion_point_targets: FK 삭제 (INDEX 유지) ------------------  
  
ALTER TABLE prepay_admin.campaign_promotion_point_targets  
    DROP FOREIGN KEY fk_point_targets_promotion;  
  
  
-- 5. campaign_promotion_point_results: FK 삭제 후 UK 추가 --------------------  
ALTER TABLE prepay_admin.campaign_promotion_point_results  
    DROP FOREIGN KEY fk_point_results_target;  
  
ALTER TABLE prepay_admin.campaign_promotion_point_results  
    DROP FOREIGN KEY fk_point_results_promotion;  
  
ALTER TABLE prepay_admin.campaign_promotion_point_results  
    ADD UNIQUE KEY uk_point_results_target (point_target_id);
```

---

## 테스트 데이터 생성

```sql
-- 상품권 데이터 조회
select campaign_code, voucher_number, issue_amount as amount, valid_until as expired_at, description as reason, is_withdrawal  
from voucher.issued_voucher  
where 1=1  
#   and campaign_code is not null  
  and campaign_code = 'camp-promotion-6'  
  and voucher_status = 'ISSUED'  
  and is_withdrawal = false  
order by issued_voucher_id desc  
;  
  
-- 특정 프로모션 삭제  
CALL prepay_admin.delete_campaign_test_data(1);  
-- 모든 테스트 데이터 삭제  
CALL prepay_admin.delete_campaign_by_code('camp-promotion-6');  
-- 상품권 데이터 자동 생성  
CALL prepay_admin.generate_campaign_voucher_from_issued('camp-promotion-6', 100, 4);  
-- 202602060800  
-- 캠페인  
select * from prepay_admin.campaign_promotions order by created_at desc;  
select * from prepay_admin.campaign_promotion_voucher_targets order by updated_at desc;  
select * from prepay_admin.campaign_promotion_voucher_results order by created_at desc;  
-- 프로모션 정보 변경
-- update prepay_admin.campaign_promotions set reservation_at = STR_TO_DATE('202601270110', '%Y%m%d%H%i'), reservation_priority = 0 where promotion_id < 10;  
  
-- 발행현황  
select promotion_id, publish_status, count(1) cnt, min(updated_at) min_updated_at, max(updated_at) max_update_at  
from prepay_admin.campaign_promotion_voucher_targets  
group by promotion_id, publish_status  
order by promotion_id desc, publish_status desc  
;  
  
-- 처리현황  
select promotion_id, process_status, count(1) cnt, max(created_at) created_at, max(updated_at) updated_at  
from prepay_admin.campaign_promotion_voucher_results  
group by promotion_id, process_status  
order by promotion_id desc, process_status desc  
;
```