# 🎯 캠페인 대량 지급 시스템 요구 사항

## 📌 Overview

> [!info] 프로젝트 목적
> 주문사(무신사)에서 페이먼츠의 머니를 사용하여 결제한 회원들을 대상으로 상품권/포인트를 지급하기 위한 **캠페인 대량 지급 시스템** 구축

### 핵심 요구 사항 요약

| 항목           | 내용                   |
| ------------ | -------------------- |
| **최대 지급 대상** | 100만(1M)이상 지급 대상 목록  |
| **처리 시간 목표** | 10 ~ 20분             |
| **데이터 일관성**  | Eventual Consistency |
| **캠페인 동시성**  | 순차 처리 (선착순 우선)       |

---

## ✅ 기능적 요구 사항

|  #  | 요구 사항     | 설명                         |
| :-: | --------- | -------------------------- |
|  1  | 상품권포인트 지급 | 식별된 지급 대상자 목록 기준 머니 상품권/포인트 지급 |
|  2  | 지급 사유 관리  | row별 지급 사유(reason) 기록      |
|  3  | 포인트 지급 금액 관리  | 포인트 이벤트인 경우, row별 다른 지급 금액 설정 가능        |
|  4  | 재처리 프로세스  | 지급 실패 건 재처리 자동화 기능             |
|  5  | 중복 지급 방지  | 신규/재지급 시 멱등성 보장            |
|  6  | 다중 캠페인 지원 | 동일 회원이 여러 캠페인 참여 가능        |

---

## ⚡ 비기능적 요구 사항

### 성능 목표

```
┌─────────────────────────────────────────────────────────┐
│  📊 Performance Targets                                 │
├─────────────────────────────────────────────────────────┤
│  • 처리 대상: 1,000,000+ rows                             │
│  • 처리 시간: 10min ~ 20min                               │
│  • Money 시스템 TPS: 1,000+ (Rate-Limiter 적용)            │
│  • 데이터 볼륨 기반 동적 파티션 스케일링			               │
└─────────────────────────────────────────────────────────┘
```

### 설계 범위

> [!note] 설계 포함
> - 캠페인별 대용량 포인트 지급 데이터 모델링
> - 고성능 처리 아키텍처
> - `money` 시스템 API 호출 추상화

> [!warning] 설계 제외
> - 대용량 회원 데이터 수집 프로세스 (이미 DB 적재 완료 가정)

---

## 🔄 재처리 정책

### 재시도 설정

| 항목        | 값              |
| --------- | -------------- |
| 최대 재시도 횟수 | **5회**         |
| 재시도 간격    | **Backoff 3초** |
| 트리거 방식    | 자동화 재처리 요청 필요  |

### 핵심 보장 항목
- **멱등성**: 중복 지급 요청 방지
- **재처리**: 실패 건 재처리 메커니즘
- **상태 체크**: 캠페인 상태가 `진행`이 아니면 지급 차단
- **동적 스케일링 전략**: 동적으로 대용량 처리 시스템을 스케일-인/아웃 할 수 있는 전략 필요
	- 100만건 이하: 프로세스/파티션 4개
	- 100만 ~ 200만건: 프로세스/파티션 6개
	- 200만건 이상 : 프로세스/파티션 8개

---

## 🚨 에러 처리 정책

### Timeout / Circuit Breaker

| 항목 | 설정값 |
|-----|-------|
| Money API Timeout | 3초 |
| Circuit Breaker 임계치 | 연속 실패 10회 시 Open |
| Circuit Breaker 복구 대기 | 30초 후 Half-Open |

### 실패 건 처리 방안

| 시나리오 | 처리 방안 |
|---------|----------|
| 5회 재시도 최종 실패 | Dead Letter 테이블 분리 → 수동 확인 대상 |
| Money 시스템 장애 | Circuit Breaker Open → 캠페인 일시 중지 |
| 부분 실패 허용 | 허용 (성공 건은 유지, 실패 건만 재처리) |

### 긴급 중지 처리

- 캠페인 상태를 `중지`로 변경 시 신규 지급 처리 즉시 차단
- 이미 처리 중인 건은 완료까지 허용 (graceful shutdown)
- 중지 시점까지 처리된 건은 `성공` 상태 유지

---

## 📡 모니터링 요구사항

### 필수 모니터링 항목

| 항목 | 확인 방법 |
|-----|----------|
| 캠페인별 진행률 | DB 조회 (성공/실패/대기 건수) |
| 실시간 처리 TPS | 로그 기반 집계 |
| 실패율 | (실패 건수 / 전체 건수) * 100 |

### 알림 조건

| 조건 | 알림 채널 |
|-----|----------|
| 실패율 1% 초과 | Slack 알림 |
| 캠페인 완료 | Slack 알림 |
| Circuit Breaker Open | Slack 알림 (긴급) |

---

## 🔌 인터페이스 명세

### 지급 대상 조회 방식

> [!info] 지급 대상 정보
> - 지급 대상 목록 데이터는 이미 MySQL 데이터베이스에 적재된 상황
> - 지급 대상 목록 적재는 별도 프로세스로 처리하므로 해당 시스템 설계에서는 제외

#### 바우처 이벤트 대상 정보

| 컬럼명 | 타입 | 필수 | 설명 |
|-------|-----|:----:|-----|
| event_id | Integer | O | 이벤트 id(고정) |
| customer_uid | String | O | 회원 uid |
| voucher_number | String | O | 지급 상품권 번호 |
| reason | String | O | 지급 사유 |

#### 포인트 이벤트 대상 정보

| 컬럼명 | 타입 | 필수 | 설명 |
|-------|-----|:----:|-----|
| event_id | Integer | O | 이벤트 id(고정) |
| customer_uid | String | O | 회원 uid |
| amount | Integer | O | 지급 금액 |
| expiry_at | String | O | 지급 만료 일시(`yyyyMMddHHmmSS`) |
| reason | String | O | 지급 사유 |

### Money API 연동

| 항목 | 내용 |
|-----|-----|
| 프로토콜 | HTTP (내부망) |
| 인증 방식 | 내부 서비스 인증 (API Key) |
| Rate Limit | 1,000 TPS |

---

## ⚠️ 제약 사항

> [!warning] 시스템 제약
> - **내부망 전용**: 외부 네트워크 접근 불가
> - **Admin UI 미제공**: API 또는 DB 직접 운영
> - **실시간 대시보드 미제공**: 로그/DB 기반 조회

### MVP 범위

| 포함 | 미포함 |
|-----|-------|
| 대량 지급 처리 엔진 | 웹 기반 관리 화면 |
| 재처리 자동화 | 실시간 대시보드 |
| 기본 모니터링/알림 | 복잡한 권한 관리 |
