
## 기획 리뷰

> **서비스기획팀 Wiki**
> [기획 리뷰 - 02. 케이뱅크 제휴 통장, 카드](https://musinsapayments.atlassian.net/wiki/x/eYaEAw

#### 1-3. 결제 번호 정의 

|             |                                    |                  |              |
| ----------- | ---------------------------------- | ---------------- | ------------ |
| **번호 명칭**   | **설명**                             | **노출 채널**        | **기타**       |
| 무신사머니 거래 번호 | 무신사머니를 사용한 거래에 발행되는 고유 번호          | 파트너 어드민, 프리페이어드민 | 동의어 : 머니키    |
| 결제 번호       | 결제팀에서 발행해주는 결제 키                   | 파트너 어드민, 프리페이어드민 | 동의어 : 참조키    |
| 주문번호        | 각 상점에서 발행하는 주문번호                   | 팀 무신사 앱, 프리페이어드민 | 동의어 : 참조 보조키 |
| 납부자 번호      | 오픈뱅킹 동의한 계좌를 대상으로 발행되는 계좌 식별용 고유번호 |                  |              |

- 무신사머니 혜택 탭 신설 예정
	- 케이뱅크 외 전체 고객 대상으로 혜택(리워드) 받은 내역을 볼 수 있는 신규 탭 메뉴
- 제휴계좌 연결은 1대1 관계, 제휴계좌 연결과 충전계좌 등록은 별개 프로세스
- 오픈뱅킹 동의를 하지 않는 경우, 계좌 인금/인출도 불가

- 제휴통장 개설을 무신사 앱에서만 가능하도록 제약
- 무신사페이머니 & 케이뱅크 가입해야만 제휴통장 개설 가능
- 제휴통장을 개설하게 되면, 무신사페이머니 계좌로 사용되며 & 기존 충전 금액이 케이뱅크 통장으로 이체 됨
	- 기존 금액이 케이뱅크 통장으로 바로 이체 된다..? - 네이버페이도 계좌 개설 시 바로 충전금을 바로 이체하고 있음

- 화면 구조 검토 필요: 무신사 앱 > 페이먼츠 웹뷰 > 케이뱅크 웹뷰

- 제휴통장 연결 후 출금이체 동의할 때, 제휴통장의 계좌번호 고정 노출 필요
	- 계좌번호 마스킹 처리는 하지 않아도 됨
	- 본인 인증한 경우에는 마스킹 처리하지 않다도 된다는 것이 법률적인 검토 사항
	- 페이먼츠 정책은 인증 프로세스에서는 마스킹하지 않고, 마이페이지에서는 마스킹 처리
- ARS인증: 출금이체 동의를 위한 인증 절차
- 계좌인증: 계좌에 대한 인증 절차

---

## 시스템 아키텍처 리뷰

>  **선불개발팀 아키텍처 Wiki**
>  [뱅킹연동 프로젝트(with kbank)](https://musinsapayments.atlassian.net/wiki/spaces/WSDTJ9YZfWBP/pages/43974660/with+kbank)

- `money-public-api`: 앱 퍼블릭 네트워크 환경에서 요청하는 public api 서버
- `money-internal-api`: 무신사 플랫폼 환경에서 요청하는 internal api 서버
- `kbank-outbound`: 케이뱅크 외부 연동을 별도 도메인으로 분리하여 애플리케이션으로 구축
- `money_list`: 머니 서비스 이력 테이블
- 헥토 api fall-back 전략: 페이먼츠에는 실패 응답을 주고, 헥토에서 재처리 또는 환불 처리
	- 성호님 의견: 페이먼츠에서 트랜잭션 요청 주체이니, 외부 api 연동에 재처리 부담을 그대로 넘기는 것보단 자체적으로도 재처리 또는 방어 프로세스 필요

### 계좌 개설 프로세스
- 케이뱅크 `상품 이용 사전 조회 요청` api 에서 `다음 스텝 정보` 응답을 받아 다음에 이어갈 정보 저장 필요
- 케이뱅크는 오픈뱅킹 동의를 받아야만 사용할 수 있는 서비스
- 오픈뱅킹 동의하는 프로세스가 무조건 성공이 안될 수도 있다??
	- 결제팀에서 별도 batch 프로세스를 통하여 오픈뱅킹 등록 실패건은 재처리 중
	- 펌뱅킹 & 오픈뱅킹을 동의했다는 필수 조건으로 봐야한다면, 결제팀 & 선불팀 협업 필요
		- 1원인증 다계좌 인증 시스템할 때, 함께 개발 진행 필요

### 계좌 충전 프로세스(머니 충전하기)
- 수납 이체: 헥토 api 를 통하여 `고객계좌 > 서비스 모계좌(페이먼츠)` 출금 이체 처리
	- 해당 이체 프로세스를 오픈뱅킹으로 처리되어야 함!!
- 지급 이체: `서비스 모계좌(페이먼츠) > 케이뱅크 고객 개인 계좌` 출금 이체 처리

### 송금 프로세스
- 추가 논의가 필요하여 추후 공유 예정

### 매일머니받기 프로세스
- `머니 마이페이지` 에서 케이뱅크 이벤트 링크 랜더링 필요

### 결제 프로세스
- 케이뱅크로 결제 api 요청하는 경우는???
	- 케이뱅크 계좌에서 무신사머니로 충전을 하였고, 그 충전금액으로 결제를 하는거 아닌가?
	- `고객 개인 계좌 > 서비스 모계좌(페이먼츠)` 출금 이체 처리

### 결제 취소 프로세스
- 사용 금액 구분 별로 결제 취소금 환급 처리

### 조회 프로세스
- 케이뱅크에서 발생하는 리워드는 페이먼츠 쪽에서 알수가 없음
	- 사유: `케이뱅크 > 페이먼츠` 정보 제공은 별도 동의 절차 필요
	- ??? 잘 모르겟음...

> 트래픽이 많아지는 걸 이슈가 아닌 적절한 대응 방안으로 해결 필요
- UDH ????
